# [주디노트 업데이트 자&김 v1_20260226.1450] - 최종 구현 및 아키텍처 합의안

**작성일시**: 2026-02-26 14:50
**참석자/검토자**: 기획(팀장/사용자), 자비스(PO), 김감사(QA)
**문서 목적**: 주디 노트의 '메모 수정/취소선/삭제' 기능 개발 착수를 위한 최종 기술/UX 합의안 확정. 

---

## 🎯 1. 최종 의사결정 서머리 (Decision Summary)

가장 첨예했던 프론트엔드 UX 설계와 관련하여, 사용자(팀장)의 최종 승인 아래 **자비스 PO의 의견(1-Depth 직관적 UI)을 채택**하고 김감사의 의견(점 3개 드롭다운 메뉴)은 기각합니다. 단, 김감사님이 지적하신 **치명적 백엔드 결함(동시성/데이터유실)은 100% 수용**하여 아키텍처를 대폭 보완합니다.

| 분류 | 항목 | 김감사 제안 | 자비스 반대의견/대안 | **최종 결정 (사용자 승인)** |
| :-- | :--- | :--- | :--- | :--- |
| **UX/UI** | **메모 액션 버튼 위치** | 더보기 메뉴 (점 3개) 안에 숨기기 | **1-뎁스 아이콘 노출** (`✏️`, `✓`, `🗑️`) | 🟢 **자비스 안 채택**: 빠르고 직관적인 One-Depth 조작으로 생산성 향상. 클릭 시 오작동(특히 삭제)만 2단계 컨펌 모달로 강력 방어. |
| **백엔드** | **동시성(Lock) 제어** | `LockService` 전면 필수 도입 | (이견 없음, 전적 동의) | 🟢 **김감사 안 채택**: 슬랙 봇 입력과 웹 수정을 동시에 할 경우 발생하는 파일 덮어쓰기 데이터 유실 100% 차단. |
| **백엔드** | **백업 시스템 구축** | 2-Phase Commit 백업 (임시파일) | (이견 없음, 전적 동의) | 🟢 **김감사 안 채택**: 파싱 오류로 1달치 파일 통째로 날아가는 크래시 방어. |

---

## 🏗️ 2. 상세 구현 계획 (Implementation Details)

### 🎨 프론트엔드 (클로이 - Web UI)

**1. 1-Depth 직관적 UI (자비스 방식 적용)**
*   각 메모(`.memo-block`) 우측 영역에 3개의 액션 버턴(`✏️`, `✓`, `🗑️`)을 배치합니다.
*   기본적으로 흐리게(Opacity 30% 등) 보이게 하거나 안보이게 하다가, 마우스 호버(데스크탑) 혹은 빈 공간 터치(모바일) 시 뚜렷하게(Opacity 100%) 보이도록 구현합니다. 드롭다운이나 팝업 메뉴를 거치지 않고 원클릭으로 바로 액션을 실행합니다.

**2. 2단계 안전 삭제 모달 (김감사 방식 적용)**
*   `🗑️ 삭제` 버튼을 누르면 즉시 지워지지 않고, *"정말 이 메모(앞 50글자...)를 삭제하시겠습니까?"* 라는 위험(Danger) 모달 팝업이 출력됩니다.
*   삭제 완료 후 서버 응답이 성공하면 화면에서 부드럽게 페이드아웃 되며, 우발적 실수를 방지하기 위해 3초 동안 하단 토스트 메시지에 `[실행 취소(Undo)]` 버튼을 제공합니다. (선택적 구현).

**3. 인라인 텍스트 수정**
*   `✏️ 수정` 클릭 시 해당 텍스트 노드가 즉시 `<textarea>` 로 변경되며 원래 텍스트가 채워집니다. 아래부분에 작게 `[저장]` / `[취소]` 버튼을 표출.
*   API 응답 대기 중 버튼은 로딩 상태(Disabled 처리)로 바뀝니다.

---

### ⚙️ 백엔드 (에이다 & 허밋 - GAS 및 Drive 제어)

**1. 전면적인 LockService 도입 (동시성 방어)**
*   **새로운 `safeUpdateArchivedMemo()` 작성**: 수정/삭제/취소선 처리를 위한 단일 엔트리포인트 함수를 만듭니다. 
*   **기존 `appendMemoToArchive()` 수정**: 슬랙 메시지 입력 시 사용하는 이 함수에도 공통 `LockService.getUserLock()`을 걸어서 웹 수정 동작과 충돌을 방어합니다. 10초 대기(Timeout) 초과 시 *"서버 혼잡/수정 중복으로 인해 실패했습니다"*를 반환합니다.

**2. 2-Phase Commit 백업 시나리오**
*   수정을 시작할 때 원본 `.md` 파일을 먼저 백업(`[파일명]_backup_[Timestamp].md`)합니다.
*   **파일 무결성 검증**: 서버에서 정규식 파싱/치환 후 텍스트 길이가 극단적으로 짧아지거나, `## 2026-` 와 같은 날짜 헤더 개수가 이전보다 줄어든다면 '파싱 충돌(에러)'로 간주하고 백업본으로 롤백합니다. 
*   성공 시 백업 파일을 파기(`setTrashed`) 처리합니다.

**3. 단일 매칭 강제 파서 (허밋)**
*   동일 시간에 비슷한 내용이 있을 수 있는 극단적 케이스 방어를 위해, `dateStr`, `timeStr`, `originalContent` 3가지 인덱스를 모두 검사하여 **파일 내에 매칭되는 건이 "정확히 1건일 때만"** 텍스트를 치환(Replace)합니다. 매칭이 0건이거나 2건 이상이면 치환을 폐기하고 에러코드(`ERR_DUPLICATE_CONTENT`)를 프론트로 넘깁니다.

---

## 🚀 3. 다음 액션 플랜 (Next Steps)

최종 결정과 요구사항 스펙이 고정되었습니다. 즉시 코드 레벨 구현(EXECUTION) 단계로 진입할 준비가 완료되었습니다.

1.  에이다/허밋 주도로 `drive_archive.gs` 내 `safeUpdateArchivedMemo` 백엔드 로직 선개발.
2.  클로이 주도로 `judy_note.html` 웹 UI(1-Depth 아이콘 및 인라인 에디터) 개발 및 연동. 
3.  개발 완료 후 김감사를 호출하여 실제 코드 리뷰 및 QA 테스트 진행.
