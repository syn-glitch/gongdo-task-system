# 시스템 개발 시 핵심 유의사항 가이드

Google Apps Script(이하 GAS)와 Slack을 연동하여 개발할 때 부딪힐 수 있는 수많은 함정과 권한 문제에 대한 노하우를 정리한 문서입니다. 차기 개발이나 유지보수 시 반드시 참고하여 안전하게 시스템을 확장하세요.

---

## 🛑 1. Slack 모달(Modal) 타임아웃과 302 리다이렉트 현상
개발하면서 마주치는 가장 크고 해결하기 어려운 이슈가 바로 Slack의 엄격한 모달 응답(HTTP) 규칙입니다.

### 문제 상황
- Slack 사용자가 팝업 모달에서 데이터를 제출(`view_submission`)했을 때, 슬랙 서버는 **무조건 3초 이내에 200 OK 응답**을 받아야만 정상 종료로 인정합니다.
- 시간이 초과되면 붉은색 오류 경고창(`We had some trouble connecting`)이 표출됩니다.

### 근본적인 원인 (GAS의 특성)
슬랙에 성공 응답(예: "모달을 닫아라")으로 JSON 형식을 보내려고 할 때, **Google 서버(GAS)는 외부로 응답을 던져줄 때 항상 302 Redirect를 통해 임시 URL을 거치도록 강제합니다.** (보안상의 이유)
하지만 슬랙은 `302 리다이렉트`를 만나면 데이터를 전혀 읽지 않고 파싱을 포기(실패)해버립니다. 따라서 *GAS가 아무리 빠르게 응답해도 302를 뱉어내는 한 항상 에러 창이 뜹니다.*

### 해결 방식 (현재 적용된 우회 방법)
1. **JSON을 보내지 마라:** `return ContentService.createTextOutput("");`와 같이 완전히 **빈 문자열**을 반환하면 GAS가 302 대신 바로 200 OK를 내려줍니다. 이러면 슬랙은 오류 없이 부드럽게 창을 닫아줍니다.
2. **저장/처리 작업은 분리해라 (비동기)**: 빈 문자열을 응답하면 사용자에게 결과 창 등을 띄워줄 수가 없고 3초 내에 Google Sheets 저장까지 완료하기엔 부담이 큽니다.
   👉 이를 위해 **`PropertiesService`를 이용해 임시 저장소에 입력받은 데이터를 쑤셔넣고**,
   👉 **`ScriptApp.newTrigger`를 활용하여 "백그라운드에서 1밀리초 뒤(실질적으로는 약 1분 이내)에 시트에 데이터를 기록하라"고 예약(예약 스케줄러 등록)**한 뒤 구글과 통신을 끊습니다.
3. 이 방식 덕분에 슬랙 모달은 즉시 닫히고, 시트 저장은 백그라운드 환경에서 안심하고 느긋하게 진행될 수 있습니다.

---

## 📆 2. 캘린더 등 "외부 API" 사용 시 권한(OAuth) 주의
GAS의 단순 '셀 편집 감지'(`onEdit` 같은 Simple Trigger) 함수를 만들 때 흔히 겪는 권한 문제입니다.

### 권한 차단 문제
- `onEdit(e)`와 같은 단순 트리거는 구글 시트 셀이 수정될 때마다 자동 실행됩니다. 하지만 **"이메일 발송", "캘린더(Calendar App) 접근", "외부 URL Fetch API 호출" 같이 프라이버시가 담긴 기능들은 실행 권한을 강제로 차단당합니다.** (에러 발생 혹은 묵묵부답 발생)

### 해결 방식 (Installable Trigger)
- 이런 기능들을 사용하기 위해서는 단순 함수명(`onEdit`)을 피하고 별도의 함수명(예: `processTasksEdit`)을 지어준 다음,
- GAS 편집기 화면의 **좌측 [트리거] 메뉴(시계 아이콘)에서 직접 수동으로 이 함수를 '수정 시(on edit)' 트리거로 등록해 주어야 합니다.**
- 등록하는 과정에서 표시되는 **Google의 공식 권한(OAuth) 검토 화면에서 `캘린더 접근 권한` 등을 직접 승인**해 주어야먄 백그라운드 스크립트가 해당 계정의 권한을 얻어 안심하고 동작할 수 있습니다.

---

## 📅 3. Date 형변환과 날짜 호환성 이슈
슬랙의 DatePicker 블록이나 다른 API를 통해 전달받는 '날짜 값'은 대부분 단순 **안전한 문자열(String; 예 "2026-03-01")** 형태입니다.

- 이 상태 그대로 `CalendarApp`의 `createAllDayEvent` 함수 등에 집어넣으면 "Invalid argument" 에러가 발생하며 생성이 죽어버립니다.
- 따라서 외부에서 넘어온 날짜를 쓸 때는 항상 `new Date("2026-03-01")`처럼 **자바스크립트 Date 객체로 형변환을 안전하게 한 번 파싱(Parsing)** 한 뒤 API에 넘겨주는 방어 로직(`calendar_sync.gs` 내부 참고)을 잊지 마세요.

---

## ⚡ 5. AI 에이전트 전전용 Fast-Track (긴급 조치) 및 ActionLog 정책
팀의 속도와 데이터 무결성을 동시에 잡기 위한 운영 가이드입니다.

### Fast-Track (선조치 후보고)
- **대상**: 1시간 이내 완료 가능한 가벼운 UI 수정, 명백한 오타/버그 해결, 단순 로깅 추가 등.
- **프로세스**: 
  1. 기획/승인 단계 생략 후 즉시 코드 수정.
  2. 수정 후 `ActionLog` 시트에 명확한 사유 기록.
  3. 수정 완료 내용을 슬랙이나 보고 채널에 사후 공유.
- **주의**: 핵심 아키텍처 변경이나 DB 스키마 수정 시에는 절대 사용 금지.

### ActionLog (데이터 변경 이력 관리)
- 모든 AI 에이전트는 데이터를 변경(등록, 수정, 삭제)하는 핵심 로직 끝에 반드시 `logAction()` 함수를 호출해야 합니다.
- **필수 포함 데이터**:
  - `user`: 수정 주체 (에이전트명 또는 사용자명)
  - `action`: 행위 유형 (Register, Update, Delete, Status Change 등)
  - `taskId`: 대상 데이터의 고유 ID
  - `oldValue` / `newValue`: 변경 전후의 핵심 값 비교
- **목적**: 시스템 오류 발생 시 원인 추적과 김감사(QA)의 Weekly Report 자동화 기반으로 활용됩니다.
