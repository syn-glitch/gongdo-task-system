# 10단계 Implementation Plan: 슬랙 기반 일회용 토큰 인증 (Magic Link Auth)

> **최종 작성일**: 2026-02-22  
> **목표**: 보안성(타인 메모 열람 방지)과 편의성(자동 로그인)을 100% 만족하는 노코드 인증 시스템 구축

---

## 1. 도입 배경 및 이전 방식(SSO) 실패 사유 회고

### ❌ 이전 방식: Google Session Auth (SSO) 시도
- **접근**: 접속자의 구글 계정 이메일을 `Session.getActiveUser().getEmail()` 로 읽어들여 엑셀 화이트리스트와 대조하는 방식을 시도함.
- **실패 사유**: 
  - 공도 팀은 단일 구글 워크스페이스가 아닌 **다중 도메인 환경**(`@microchool.kr`, `@gongdo.kr`, `@gmail.com` 혼용)을 사용 중.
  - 이를 우회하기 위해 GAS 배포 시 **액세스 권한을 '모든 사용자'로 개방**해야 했고, 이로 인해 사용자가 **"이 앱이 내 정보에 접근합니다"라는 구글 권한 승인(OAuth Consent) 팝업을 거쳐야만 하는 심각한 UX 저하**가 발생함.
  - 팀원들이 이 무서운 권한 승인 창을 보고 이탈하거나 혼란을 겪을 가능성이 농후하여 최종 기각됨.

### ✅ 새로운 해법: Slack-Based Magic Link (일회용 토큰 인증)
- **개념**: **이미 완벽하게 신원이 보장된 "슬랙(Slack)"** 플랫폼을 인증의 지렛대(Identity Provider)로 활용하는 방식.
- **방식**: 슬랙 봇이 팀원에게 웹 메모장 링크를 줄 때, 예측 불가능한 `일회용 난수 토큰(Token)`을 주소에 붙여서 발행하고, 웹 메모장에 접속하면 이 토큰을 서버의 캐시(Cache)와 대조하여 로그인 처리.

---

## 2. 'Magic Link' 시스템 동작 아키텍처 (3단계)

### Step 1. 슬랙에서 토큰 발행 (`slack_command.gs`)
1. 팀원이 슬랙에서 `/주디 노트` 명령어 입력 (또는 특정 버튼 클릭).
2. 봇이 해당 팀원의 실명(예: `송용남`)을 파악함.
3. 봇이 16자리의 무작위 문자열(토큰, 예: `Xj9A2...`)을 생성함.
4. `CacheService`를 이용해 이 토큰을 열쇠(Key)로, 팀원 이름(`송용남`)을 값(Value)으로 **10분(600초) 동안만 구글 서버 메모리에 저장**함. (수명 만료 시 자동 소멸로 보안 극대화).
5. 봇이 개인 DM으로 `[주디 노트 열기]` 버튼을 전송하되, 버튼의 URL은 `https://script.google.com/.../exec?token=Xj9A2...` 형태로 조립됨.

### Step 2. 웹 앱 진입 및 토큰 검증 (`web_app.gs`)
1. 팀원이 슬랙에서 버튼(링크)을 클릭하여 브라우저 진입.
2. `doGet(e)` 함수가 URL에 파라미터로 붙어있는 `token` 값을 낚아챔.
3. 곧바로 백엔드의 `validateToken(token)` 함수가 실행되어, 서버 캐시(`CacheService`)에 해당 토큰이 존재하는지 검증.
4. **검증 성공**: 캐시에서 `송용남` 이라는 이름을 꺼내어 프론트엔드로 전달 후, **해당 토큰은 즉시 파기(삭제)**하여 재사용을 원천 봉쇄함 (One-Time Password 원리).
5. **검증 실패**(또는 토큰 없음): "접근 권한이 없거나 만료된 링크입니다. 슬랙에서 다시 접속해주세요" 반려.

### Step 3. 프론트엔드 안전 렌더링 (`judy_note.html`)
1. 서버 검증을 무사히 통과하고 `송용남` 이름을 넘겨받은 프론트엔드 코드:
2. 기존의 위험한 수동 선택형 드롭다운(`<select id="userSelect">`)을 **완전 삭제**함.
3. 대신 우측 상단에 뱃지로 `[👤 송용남 님]` 을 고정 노출함.
4. 건네받은 이름으로만 `getArchivedMemos("송용남")` 을 호출하여 본인의 과거 메모만 사이드바에 렌더링함. (타인 메모 탈취 불가능).

---

## 3. 이 방식의 장점 (Pros)
- **구글 권한 승인 창 없음(No OAuth Consent)**: 골치 아픈 스코프나 권한 팝업 없이 링크 클릭만으로 1초 만에 스무스하게 접속됨.
- **다중 도메인 완벽 대응**: 접속자의 브라우저 이메일과 무관하게, 슬랙에서 누구였는지만 점검하므로 도메인 종류가 100개여도 상관없음.
- **브루트포스(주소 조작) 원천 차단**: 주소창에 `?name=김개발` 처럼 이름을 쳐서 남의 방에 들어가는 꼼수가 불가능해짐. 토큰은 10분 뒤, 또는 1회 사용 시 즉시 증발함.
- **최고의 UX**: 슬랙이라는 업무 공간의 연장선상에서 "원클릭 자동 로그인" 경험을 제공함.

## 4. 검증 시나리오 (Verification Plan)
1. 슬랙봇에 메시지를 보내 일회용 토큰이 포함된 링크 버튼을 개인 DM으로 정상 수신하는지 확인.
2. 해당 버튼 클릭 시, 웹 메모장이 브라우저에 열리고 이름 드롭다운 없이 **자동으로 본인 이름**이 인식되어 렌더링되는지 확인.
3. 브라우저 주소창에 있는 토큰을 복사한 뒤 시크릿 창이나 다른 브라우저에 붙여넣고 엔터를 치면 **"만료된 링크" 라며 접속이 차단**되는지(1회용 소멸 기능 정상 작동) 확인.
4. URL에서 `?token=` 부분을 지우거나 임의로 글자를 바꿔서 접속 시도 시 거부되는지 확인.
