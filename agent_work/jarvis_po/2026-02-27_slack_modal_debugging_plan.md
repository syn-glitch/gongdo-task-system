# 🚀 슬랙 모달 랜덤 에러 디버깅 계획 및 작업 명세 (Hotfix v2.0)

**작성자**: 자비스 (PO / 구현 에이전트)
**기반 문서**: 김감사 QA 팀의 `2026-02-27_slack_modal_error_qa_v2.md`
**대상 이슈**: 
1. `/주디` 명령어 타임아웃 (캐시 미스 시 구글 시트 조회로 인한 3초 초과)
2. 모달 제출 후 타임아웃 팝업 (PropertiesService 쓰기 지연에 따른 3초 초과)

---

## 🛠 디버깅 및 해결 로직 설계 (Solution Architecture)

### 1. `/주디` 명령어 모달 오픈 타임아웃 해결 (캐시 워밍업)
- **원인**: `getProjectOptions()`에서 1시간마다 캐시가 만료되면 다음 사용자가 슬랙 `/주디`를 입력했을 때 시트를 직접 읽는데 2~3초가 걸려 슬랙의 3초 제한을 넘겨버림.
- **해결 방안 (Solution #1)**: 
  - `slack_command.gs` 최하단에 `warmupProjectCache()` 함수 정의.
  - 구글 시트를 읽어 1시간(3600초)짜리 캐시를 재생성하는 로직을 담음.
  - **(중요)** 이 함수를 GAS의 **`시간 기반 트리거(Time-driven Trigger)`를 통해 매 10분마다 자동 실행되도록 스케줄링(사용자 직접 세팅 필요)**하여 캐시 미스가 사용자의 동작 시점에 발생하지 않도록 차단.

### 2. 모달 제출 후 타임아웃 팝업 해결 (저장소 마이그레이션)
- **원인**: `PropertiesService`에 큰 용량의 JSON(`taskData`)을 쓸 때 평균 300~1000ms가 걸리며, 콜드 스타트 2초까지 겹치면 슬랙 3초 제한에 걸림.
- **해결 방안 (Solution #2)**: 
  - **이중 저장소 전략 (Hybrid Storage)**: `CacheService`는 속도가 10ms 이내로 매우 빠르지만 전체 키를 조회하는 `getKeys()` 함수가 없음. 반면 `PropertiesService`는 큰 데이터를 저장하면 느리지만 키 목록 조회(`getProperties()`)가 가능함.
  - **대용량 데이터는 CacheService에, 키 인덱스(1바이트)는 PropertiesService에 저장**하여 쓰기 속도를 극대화(10ms 이내)하면서도 비동기 프로세스(`processAsyncTasks`)에서 안전하게 키를 찾아와 데이터를 불러올 수 있도록 아키텍처 개선.

### 3. 제출 시 Optimistic UI (긍정적 사용자 피드백) 제공
- **원인**: 기존 코드는 제출(`view_submission`) 즉시 빈 응답(200 OK)만 반환하여 뷰가 닫혀버림. 백그라운드 작업이 도는지 알 수 없고 앱이 멈춘 것으로 오해할 수 있음.
- **해결 방안 (Solution #3)**:
  - 빈 텍스트를 반환하는 대신, `response_action: "update"` 옵션을 사용해 현재 모달의 로딩 화면("데이터를 저장 중입니다...") 블록 구조로 교체해주는 JSON을 반환.
  - 슬랙 앱 서버가 3초 제한 안에 즉각 반응하여 화면을 업데이트해주기 때문에 부드러운 UX 가능.

---

## 📅 파일 배포 및 업데이트 사항

1. `slack_command.gs` 코드를 위 3가지 핵심 피드백을 반영하여 전면 리팩터링합니다.
2. `CacheService`와 `PropertiesService` 분리 구조, `warmupProjectCache` 생성 로직을 꼼꼼하게 테스트한 뒤 최종 스크립트 파일(`2026-02-27_slack_command_hotfix_v3.gs`)을 산출합니다.
3. 이 디버깅 계획을 바탕으로 해야 할 코딩 체크리스트는 동일 디렉토리 내 `2026-02-27_slack_modal_task.md` 에 요약해 두겠습니다.
