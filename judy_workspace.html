<!DOCTYPE html>
<html data-theme="dark">

<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
    <style>
        :root {
            /* Dark Theme (Default) */
            --bg-color: #121212;
            --surface: #1e1e1e;
            --surface-elevated: #2d2d2d;
            --card: #1e1e1e;
            --primary: #bb86fc;
            --primary-variant: #3700b3;
            --secondary: #03dac6;
            --text-color: #e0e0e0;
            --hint-color: #888888;
            --border: #333333;
            --danger: #cf6679;
            --btn-bg: #333333;
            --btn-text: #e0e0e0;
            --toast-bg: rgba(255, 255, 255, 0.9);
            --toast-text: #121212;
            /* Add more CSS variables as needed during integration */
        }

        html[data-theme="light"] {
            --bg-color: #f8f9fa;
            --surface: #ffffff;
            --surface-elevated: #f0f0f0;
            --card: #ffffff;
            --primary: #6200ee;
            --primary-variant: #3700b3;
            --secondary: #03dac6;
            --text-color: #121212;
            --hint-color: #666666;
            --border: #e0e0e0;
            --danger: #b00020;
            --btn-bg: #ececec;
            --btn-text: #121212;
            --toast-bg: rgba(0, 0, 0, 0.8);
            --toast-text: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Pretendard', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* GNB (Global Navigation Bar) */
        .gnb {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
            height: 60px;
            background-color: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .gnb-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .gnb-brand {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gnb-tabs {
            display: flex;
            height: 60px;
        }

        .gnb-tab {
            background: transparent;
            border: none;
            padding: 0 20px;
            color: var(--hint-color);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            outline: none;
            transition: color 0.2s;
            font-family: inherit;
            display: flex;
            align-items: center;
        }

        .gnb-tab:hover {
            color: var(--text-color);
        }

        .gnb-tab.active {
            color: var(--primary);
        }

        .gnb-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }

        .gnb-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .theme-btn {
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
            outline: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .theme-btn:hover {
            background-color: var(--surface-elevated);
        }

        .user-badge {
            background: var(--surface-elevated);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 14px;
            font-weight: 600;
            user-select: none;
        }

        /* Main Container (Views) */
        .view-container {
            flex: 1;
            display: flex;
            width: 100vw;
            height: calc(100vh - 60px);
            position: relative;
            overflow: hidden;
        }

        .view-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            animation: fadeIn 0.3s ease-in-out;
            min-height: 0;
        }

        .view-panel.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--toast-bg);
            color: var(--toast-text);
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Access Denied Overlay */
        .access-denied-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: var(--text-color);
        }

        .access-denied-overlay .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .access-denied-overlay .title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .access-denied-overlay .desc {
            font-size: 15px;
            color: var(--hint-color);
            text-align: center;
            line-height: 1.6;
        }

        /* ===== Note Module CSS ===== */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background-color: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, background-color 0.3s;
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .new-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .new-btn:hover {
            background: var(--surface-elevated);
            border-color: var(--primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
            min-height: 0;
        }

        .folder-item {
            display: flex;
            flex-direction: column;
        }

        .folder-title {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .folder-title:hover {
            background-color: var(--surface-elevated);
        }

        .folder-icon {
            font-size: 16px;
        }

        .folder-children {
            display: none;
            flex-direction: column;
            padding-left: 20px;
            background: rgba(0, 0, 0, 0.02);
        }

        .folder-item.open .folder-children {
            display: flex;
        }

        .file-item {
            padding: 8px 20px 8px 30px;
            font-size: 13px;
            color: var(--text-color);
            cursor: pointer;
        }

        .file-item:hover {
            background-color: var(--surface-elevated);
            color: var(--primary);
        }

        .loading-text {
            padding: 20px;
            font-size: 13px;
            color: var(--hint-color);
            text-align: center;
        }

        .sidebar-search {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-search input {
            width: 100%;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            outline: none;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .sidebar-search input:focus {
            border-color: var(--primary);
        }

        .sidebar-search input::placeholder {
            color: var(--hint-color);
        }

        .search-result-item {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .search-result-item:hover {
            background-color: var(--surface-elevated);
        }

        .search-result-date {
            font-size: 12px;
            color: var(--primary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .search-result-text {
            font-size: 13px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .highlight {
            background-color: rgba(187, 134, 252, 0.4);
            border-radius: 2px;
            padding: 0 2px;
        }

        html[data-theme="light"] .highlight {
            background-color: rgba(98, 0, 238, 0.2);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            transition: background-color 0.3s;
            min-height: 0;
        }

        .editor-header {
            padding: 20px 40px 10px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid transparent;
        }

        .editor-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
        }

        .editor-container {
            flex: 1;
            padding: 20px 40px 40px 40px;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 0;
        }

        #memoInput {
            flex: 1;
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 15px;
            line-height: 1.6;
            font-family: inherit;
            resize: none;
            outline: none;
            padding: 0;
            overflow-y: auto;
            min-height: 0;
        }

        #memoInput::placeholder {
            color: var(--hint-color);
        }

        #memoViewer {
            flex: 1;
            width: 100%;
            font-size: 15px;
            line-height: 1.6;
            overflow-y: auto;
            white-space: pre-wrap;
            min-height: 0;
        }

        .summary-overlay {
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            background: var(--surface);
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-10px);
            max-height: 80%;
            overflow-y: auto;
        }

        .summary-overlay.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .summary-title {
            font-weight: 600;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-summary {
            background: transparent;
            border: none;
            color: var(--hint-color);
            cursor: pointer;
            font-size: 18px;
        }

        .summary-content {
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px 20px 40px;
            color: var(--hint-color);
            font-size: 13px;
        }

        .footer-buttons {
            display: flex;
            gap: 12px;
        }

        .save-btn,
        .action-btn {
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
        }

        .extract-btn,
        .action-btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-variant));
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            box-shadow: 0 4px 12px rgba(187, 134, 252, 0.3);
        }

        .save-btn:hover,
        .extract-btn:hover,
        .action-btn:hover,
        .action-btn-primary:hover {
            opacity: 0.9;
        }

        .save-btn:disabled,
        .extract-btn:disabled,
        .action-btn:disabled,
        .action-btn-primary:disabled {
            background: var(--btn-bg);
            color: var(--hint-color);
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.6;
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 90;
            transition: opacity 0.3s;
            opacity: 0;
            pointer-events: none;
        }

        .mobile-overlay.show {
            display: block;
            opacity: 1;
            pointer-events: auto;
        }

        .menu-btn-mobile {
            display: none;
            background: transparent;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
            padding: 4px;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 60px;
                bottom: 0;
                left: 0;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .menu-btn-mobile {
                display: block;
            }

            .editor-container {
                padding: 10px 20px 20px 20px;
            }

            .editor-header {
                padding: 10px 20px;
            }

            .footer {
                padding: 0 20px 20px 20px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .footer .hint {
                display: none;
            }

            .footer-buttons {
                justify-content: stretch;
            }

            .save-btn,
            .extract-btn {
                flex: 1;
                padding: 12px 16px;
            }

            .summary-overlay {
                left: 10px;
                right: 10px;
                padding: 16px;
            }

            .access-denied-overlay .desc {
                font-size: 15px;
                color: var(--hint-color);
                text-align: center;
                line-height: 1.6;
            }
        }

        /* ===== Dashboard Module CSS ===== */
        .dash-header {
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        .dash-header h1 {
            font-size: 20px;
            font-weight: 700;
        }

        .dash-header h1 span {
            color: var(--primary);
        }

        .dash-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .refresh-btn {
            background: var(--surface-elevated);
            color: var(--text-color);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--border);
        }

        .new-task-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-variant));
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(187, 134, 252, 0.2);
        }

        .new-task-btn:hover {
            opacity: 0.9;
        }

        .summary-bar {
            display: flex;
            gap: 16px;
            padding: 20px 32px;
            flex-wrap: wrap;
        }

        .summary-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 24px;
            min-width: 120px;
            text-align: center;
            transition: transform 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
        }

        .summary-card .count {
            font-size: 28px;
            font-weight: 700;
        }

        .summary-card .label {
            font-size: 12px;
            color: var(--hint-color);
            margin-top: 4px;
        }

        /* í†µê³„ ìƒ‰ìƒ */
        .count-progress {
            color: #64b5f6;
        }

        .count-waiting {
            color: #ffb74d;
        }

        .count-hold {
            color: #e57373;
        }

        .count-total {
            color: var(--primary);
        }

        .dash-tabs {
            display: flex;
            gap: 16px;
            margin: 0 32px;
            border-bottom: 2px solid var(--border);
        }

        .dash-tab-btn {
            background: transparent;
            border: none;
            padding: 12px 16px;
            color: var(--hint-color);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            position: relative;
            outline: none;
        }

        .dash-tab-btn:hover {
            color: var(--text-color);
        }

        .dash-tab-btn.active {
            color: var(--primary);
        }

        .dash-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        /* [Phase 21] íƒ€ì„ íŠ¸ë˜í‚¹ ì „ìš© ìŠ¤íƒ€ì¼ */
        .count-focus {
            color: #ff5252;
            text-shadow: 0 0 10px rgba(255, 82, 82, 0.3);
        }

        .duration-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            color: var(--hint-color);
            background: var(--surface-elevated);
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 4px;
        }

        .duration-active {
            color: #ff5252;
            background: rgba(255, 82, 82, 0.1);
        }

        .task-list-wrapper {
            flex: 1;
            padding: 20px 32px 40px;
            overflow-y: auto;
            min-height: 0;
        }

        .task-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .task-table th {
            background: var(--surface-elevated);
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--hint-color);
            text-align: left;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }

        .task-table td {
            padding: 14px 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .task-table tr:last-child td {
            border-bottom: none;
        }

        .task-table tr:hover td {
            background: rgba(187, 134, 252, 0.05);
        }

        .clickable-row {
            cursor: pointer;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-ì§„í–‰ì¤‘ {
            background: rgba(100, 181, 246, 0.2);
            color: #64b5f6;
        }

        .badge-ëŒ€ê¸° {
            background: rgba(255, 183, 77, 0.2);
            color: #ffb74d;
        }

        .badge-ë³´ë¥˜ {
            background: rgba(229, 115, 115, 0.2);
            color: #e57373;
        }

        .due-tag {
            font-size: 12px;
            white-space: nowrap;
        }

        .due-overdue {
            color: var(--danger);
            font-weight: 600;
        }

        .due-today {
            color: var(--warning, #ff9800);
            font-weight: 600;
        }

        .due-tomorrow {
            color: var(--warning, #ff9800);
        }

        .due-normal {
            color: var(--hint-color);
        }

        .status-select {
            background: var(--surface-elevated);
            color: var(--text-color);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }

        .status-select:focus {
            border-color: var(--primary);
        }

        .loading,
        .empty-state {
            text-align: center;
            padding: 60px;
            color: var(--hint-color);
            font-size: 15px;
        }

        .empty-state .emoji {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Modals */
        .dash-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 150;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .dash-modal-overlay.show {
            display: flex;
        }

        .dash-modal {
            background: var(--surface);
            border-radius: 16px;
            width: 500px;
            max-width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
            padding: 28px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .dash-modal h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--hint-color);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            outline: none;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel {
            background: var(--surface-elevated);
            color: var(--text-color);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-submit {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dashboard Mobile Responsive */
        @media (max-width: 768px) {
            .dash-header {
                padding: 16px 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .summary-bar {
                padding: 16px 20px;
                gap: 10px;
            }

            .summary-card {
                flex: 1 1 calc(50% - 10px);
                min-width: auto;
                padding: 12px;
            }

            .dash-tabs {
                margin: 0 20px;
            }

            .task-list-wrapper {
                padding: 16px 20px 40px;
            }

            .task-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }

        /* ===== Floating Task Button (ë“œë˜ê·¸ ì„ íƒ ì‹œ íŒì—…) ===== */
        .judy-float-btn {
            position: fixed;
            display: none;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 4px 16px rgba(168, 85, 247, 0.5);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            animation: floatIn 0.2s ease-out;
            white-space: nowrap;
        }

        .judy-float-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.7);
        }

        .judy-float-btn .judy-icon {
            font-size: 16px;
            line-height: 1;
        }

        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(8px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>

<body>

    <!-- Global Navigation Bar -->
    <div class="gnb">
        <div class="gnb-left">
            <div class="gnb-brand">
                <span>ğŸ°</span> Judy Workspace
            </div>
            <div class="gnb-tabs">
                <button class="gnb-tab" id="navNote" onclick="switchMainView('note')">ğŸ“ ë‚´ ë…¸íŠ¸</button>
                <button class="gnb-tab" id="navTasks" onclick="switchMainView('tasks')">ğŸ“Š ë‚´ ì—…ë¬´</button>
            </div>
        </div>
        <div class="gnb-right">
            <span id="userBadge" class="user-badge">ì¸ì¦ ì¤‘...</span>
            <button id="themeToggleBtn" class="theme-btn" title="í…Œë§ˆ ë³€ê²½" onclick="toggleTheme()">â˜€ï¸</button>
        </div>
    </div>

    <!-- Workspace Views -->
    <div class="view-container">

        <!-- View 1: Judy Note -->
        <div id="viewNote" class="view-panel" style="flex-direction: row;">
            <!-- Left Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3>ë‚´ í´ë”</h3>
                    <button id="newMemoBtn" class="new-btn">+ ìƒˆ ë©”ëª¨</button>
                </div>
                <div class="sidebar-search">
                    <input type="text" id="searchInput" placeholder="í‚¤ì›Œë“œ/íƒœê·¸ ê²€ìƒ‰ (Enter)" autocomplete="off" />
                </div>
                <div class="sidebar-content" id="folderList">
                    <div class="loading-text">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ ë¡œë”©ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Editor Header (Visible when viewing past memo) -->
                <div class="editor-header" id="editorHeader" style="display: none;">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <button id="menuBtnMobile" class="menu-btn-mobile" title="ë©”ë‰´ ì—´ê¸°">â˜°</button>
                        <h2 id="viewTitle">ì½ê¸° ëª¨ë“œ</h2>
                    </div>
                    <button id="summarizeBtn" class="action-btn-primary">âœ¨ AI ë‚´ìš© ìš”ì•½</button>
                </div>

                <div class="editor-container">
                    <!-- AI Summary Overlay -->
                    <div class="summary-overlay" id="summaryOverlay">
                        <div class="summary-title">
                            <span>âœ¨ AI ìš”ì•½ ê²°ê³¼</span>
                            <button class="close-summary" id="closeSummaryBtn">âœ•</button>
                        </div>
                        <div class="summary-content" id="summaryContent">ìš”ì•½ëœ ë‚´ìš©ì´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
                    </div>

                    <textarea id="memoInput"
                        placeholder="ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼ ì—¬ê¸°ì— ìŸì•„ë‚´ì„¸ìš”...&#10;(í…ìŠ¤íŠ¸ë¥¼ ë“œë˜ê·¸í•˜ë©´ ğŸ° ì—…ë¬´ ë“±ë¡ ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤)"></textarea>
                    <div id="memoViewer" style="display:none;"></div>
                </div>

                <!-- Footer (Visible when writing new memo) -->
                <div class="footer" id="editorFooter">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <button id="menuBtnMobile2" class="menu-btn-mobile" title="ë©”ë‰´ ì—´ê¸°">â˜°</button>
                        <span class="hint">ì €ì¥: Cmd + Enter (ë˜ëŠ” Ctrl + Enter)</span>
                    </div>
                    <div class="footer-buttons">
                        <button id="saveBtn" class="save-btn">ì¼ë°˜ ì €ì¥</button>
                    </div>
                </div>
            </div>

            <div id="mobileOverlay" class="mobile-overlay"></div>
        </div>

        <!-- ğŸ° Judy Floating Task Button (ë“œë˜ê·¸ë¡œ í…ìŠ¤íŠ¸ ì„ íƒ ì‹œ ë…¸ì¶œ) -->
        <button class="judy-float-btn" id="judyFloatBtn">
            <span class="judy-icon">ğŸ°</span> ì—…ë¬´ ë“±ë¡
        </button>

        <!-- View 2: Dashboard -->
        <div id="viewTasks" class="view-panel" style="background-color: var(--bg-color); overflow:hidden;">
            <!-- Dashboard ë‚´ë¶€ ì½˜í…ì¸ ëŠ” ìì²´ ìŠ¤í¬ë¡¤ ì˜ì—­ì„ ê°€ì§ -->
            <div style="display:flex; flex-direction:column; height:100%;">

                <div class="dash-header">
                    <h1>ğŸ“‹ <span>ë‚´ ì—…ë¬´ í˜„í™©</span></h1>
                    <div class="dash-actions">
                        <button class="new-task-btn" onclick="openRegModal()">+ ìƒˆ ì—…ë¬´ ë“±ë¡</button>
                        <button class="refresh-btn" onclick="loadTasks()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>

                <div class="summary-bar" id="summaryBar"></div>

                <div class="dash-tabs" id="tabsBar" style="display:none;">
                    <button class="dash-tab-btn active" onclick="switchTaskTab('active')" id="tab-active">ğŸ“Œ ì§„í–‰ ì¤‘
                        ì—…ë¬´</button>
                    <button class="dash-tab-btn" onclick="switchTaskTab('completed')" id="tab-completed">âœ… ì™„ë£Œëœ
                        ì—…ë¬´</button>
                </div>

                <div class="task-list-wrapper" id="taskListWrapper">
                    <div id="taskList">
                        <div class="loading">ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ì—…ë¬´ ë“±ë¡ ëª¨ë‹¬ -->
    <div class="dash-modal-overlay" id="regModalOverlay" onclick="if(event.target===this)closeRegModal()">
        <div class="dash-modal">
            <h2>â• ìƒˆ ì—…ë¬´ ë“±ë¡</h2>
            <div class="form-group">
                <label>í”„ë¡œì íŠ¸ *</label>
                <select id="formProject">
                    <option value="">ë¡œë”© ì¤‘...</option>
                </select>
            </div>
            <div class="form-group">
                <label>ì—…ë¬´ ì œëª© *</label>
                <input type="text" id="formTitle" placeholder="ì—…ë¬´ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label>ì—…ë¬´ ë‚´ìš©</label>
                <textarea id="formDesc" placeholder="ìƒì„¸ ë‚´ìš© (ì„ íƒ)"></textarea>
            </div>
            <div class="form-group">
                <label>ë§ˆê°ì¼</label>
                <input type="date" id="formDue">
            </div>
            <div class="form-group">
                <label>ìƒíƒœ</label>
                <select id="formStatus">
                    <option value="ëŒ€ê¸°">â¸ ëŒ€ê¸°</option>
                    <option value="ì§„í–‰ì¤‘">â–¶ ì§„í–‰ì¤‘</option>
                    <option value="ë³´ë¥˜">ğŸ”´ ë³´ë¥˜</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeRegModal()">ì·¨ì†Œ</button>
                <button class="btn-submit" id="submitRegBtn" onclick="submitNewTask()">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì—…ë¬´ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="dash-modal-overlay" id="editModalOverlay" onclick="if(event.target===this)closeEditModal()">
        <div class="dash-modal">
            <h2>ğŸ“ ì—…ë¬´ ìƒì„¸ ë° ìˆ˜ì •</h2>
            <input type="hidden" id="editRowNum">
            <div class="form-group">
                <label>ì—…ë¬´ ì œëª© *</label>
                <input type="text" id="editTitle" placeholder="ì—…ë¬´ ì œëª©">
            </div>
            <div class="form-group">
                <label>ìƒì„¸ ë‚´ìš©</label>
                <textarea id="editDesc" placeholder="ìƒì„¸ ë‚´ìš©"></textarea>
            </div>
            <div class="form-group" style="display:flex; gap:16px;">
                <div style="flex:1;">
                    <label>ë§ˆê°ì¼</label>
                    <input type="date" id="editDue">
                </div>
                <div style="flex:1;">
                    <label>ìƒíƒœ</label>
                    <select id="editStatus">
                        <option value="ëŒ€ê¸°">â¸ ëŒ€ê¸°</option>
                        <option value="ì§„í–‰ì¤‘">â–¶ ì§„í–‰ì¤‘</option>
                        <option value="ë³´ë¥˜">ğŸ”´ ë³´ë¥˜</option>
                        <option value="ì™„ë£Œ">âœ… ì™„ë£Œ</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeEditModal()">ë‹«ê¸°</button>
                <button class="btn-submit" id="submitEditBtn" onclick="submitEditedTask()">ìˆ˜ì •í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Global Toast -->
    <div id="toast" class="toast">
        <span id="toastMsg">ì•Œë¦¼ ë©”ì‹œì§€</span>
    </div>

    <!-- Access Denied Overlay -->
    <div id="accessDeniedOverlay" class="access-denied-overlay" style="display: none;">
        <div class="icon">â›”</div>
        <div class="title">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="desc" id="accessDeniedMsg">ë¹„ì •ìƒì ì¸ ì ‘ê·¼ì…ë‹ˆë‹¤.<br>ìŠ¬ë™ì—ì„œ ë‹¤ì‹œ ë§í¬ë¥¼ ë°œê¸‰ë°›ì•„ì£¼ì„¸ìš”.</div>
    </div>

    <script>
        // URL/Backend Parameters
        const initialPage = '<?= initialPage ?>';
        const magicToken = '<?= token ?>';
        const initUserId = '<?= userId ?>';
        const initUserName = '<?= userName ?>';

        // Global State
        let currentHtmlTheme = 'dark';
        let g_userId = null;
        let g_userName = null;

        // Elements
        const accessDeniedOverlay = document.getElementById('accessDeniedOverlay');
        const accessDeniedMsg = document.getElementById('accessDeniedMsg');
        const userBadge = document.getElementById('userBadge');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMsg');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const htmlEl = document.documentElement;

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Theme init
            const savedTheme = localStorage.getItem('judy_workspace_theme') || 'dark';
            setTheme(savedTheme);

            // 2. Auth Flow
            // If we have token, it's a Note entry. If we have userId/userName, it's a direct Tasks entry.
            if (magicToken) {
                validateMagicToken(magicToken);
            } else if (initUserId && initUserName) {
                // ì´ë¯¸ ì£¼ë”” ë‚´ì—…ë¬´ ëª…ë ¹ì–´ë¥¼ íƒ€ê³ ì˜¨ ê²½ìš°
                setAuthenticatedUser(initUserId, initUserName);
                switchMainView(initialPage || 'tasks');
            } else {
                // ë‘˜ë‹¤ ì—†ìœ¼ë©´ ë¯¸ì¸ê°€
                showAccessDenied('ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ëœ ì ‘ì† ì •ë³´ì…ë‹ˆë‹¤.<br>ìŠ¬ë™ì—ì„œ ë‹¤ì‹œ ì ‘ì†í•˜ì„¸ìš”.');
            }
        });

        // --- Authentication ---
        function validateMagicToken(token) {
            google.script.run
                .withSuccessHandler((result) => {
                    if (result.valid) {
                        // result doesn't have userId currently, maybe we can fetch it or just use userName.
                        setAuthenticatedUser(null, result.name);

                        // Clean URL
                        if (window.history.replaceState) {
                            const cleanUrl = window.location.href.split('?')[0];
                            window.history.replaceState({}, document.title, cleanUrl);
                        }
                        switchMainView(initialPage === 'tasks' ? 'tasks' : 'note');
                    } else {
                        showAccessDenied(result.reason);
                    }
                })
                .withFailureHandler((err) => {
                    showAccessDenied('ì¸ì¦ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ìƒˆë¡œê³ ì¹¨ í•˜ê±°ë‚˜ ìŠ¬ë™ì—ì„œ ë‹¤ì‹œ ì ‘ì†í•˜ì„¸ìš”.');
                })
                .validateToken(token);
        }

        function setAuthenticatedUser(uid, uname) {
            g_userId = uid;
            g_userName = uname;
            userBadge.textContent = "ğŸ‘¤ " + uname + " ë‹˜";

            // [Phase 21] ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸ (íŠ¸ë˜í‚¹ ê¸°ëŠ¥ ë…¸ì¶œ ì œì–´)
            window.isAdmin = ["ì†¡ìš©ë‚¨", "ì •í˜œë¦¼"].includes(uname);

            // ëª¨ë“ˆ ì´ˆê¸°í™”
            initNoteModule();
            // initTasksModule(); ì€ íƒ­ ì§„ì… ì‹œì ì— ìµœì´ˆ 1íšŒ ë¡œë“œí•˜ë„ë¡ ì§€ì—° ì²˜ë¦¬
        }

        function showAccessDenied(reason) {
            userBadge.textContent = 'â›” ë¯¸ì¸ê°€';
            accessDeniedMsg.innerHTML = reason;
            accessDeniedOverlay.style.display = 'flex';
        }

        // --- View Switching ---
        function switchMainView(viewName) {
            document.getElementById('navNote').classList.remove('active');
            document.getElementById('navTasks').classList.remove('active');
            document.getElementById('viewNote').classList.remove('active');
            document.getElementById('viewTasks').classList.remove('active');

            if (viewName === 'note') {
                document.getElementById('navNote').classList.add('active');
                document.getElementById('viewNote').classList.add('active');
            } else if (viewName === 'tasks') {
                document.getElementById('navTasks').classList.add('active');
                document.getElementById('viewTasks').classList.add('active');

                // Dashboard ìµœì´ˆ ì§„ì… ì‹œ ë¡œë“œ
                if (!window._tasksInitialized) {
                    if (typeof initTasksModule === 'function') {
                        initTasksModule();
                    }
                    window._tasksInitialized = true;
                }
            }
        }

        // --- Theme & Toast ---
        function toggleTheme() {
            const newTheme = currentHtmlTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            currentHtmlTheme = theme;
            htmlEl.setAttribute('data-theme', theme);
            themeToggleBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('judy_workspace_theme', theme);
        }

        let toastTimeout;
        function showToast(msg, isError = false) {
            toastMsg.textContent = msg;
            toast.classList.add('show');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ==========================================
        // Note Module Logic
        // ==========================================
        let currentMode = 'write';
        let cachedSidebarData = null;

        const memoInput = document.getElementById('memoInput');
        const memoViewer = document.getElementById('memoViewer');
        const folderList = document.getElementById('folderList');
        const searchInput = document.getElementById('searchInput');
        const editorHeader = document.getElementById('editorHeader');
        const editorFooter = document.getElementById('editorFooter');
        const viewTitle = document.getElementById('viewTitle');
        const summaryOverlay = document.getElementById('summaryOverlay');
        const summaryContent = document.getElementById('summaryContent');
        const saveBtn = document.getElementById('saveBtn');
        const judyFloatBtn = document.getElementById('judyFloatBtn');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const newMemoBtn = document.getElementById('newMemoBtn');
        const closeSummaryBtn = document.getElementById('closeSummaryBtn');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobileOverlay');

        // ë‹¨ì¶•í‚¤
        if (memoInput) {
            memoInput.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (currentMode === 'write') saveMemo('saveFromWeb');
                }
            });
        }

        // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°”
        function toggleMobileMenu() {
            sidebar.classList.toggle('open');
            mobileOverlay.classList.toggle('show');
        }
        function closeMobileMenu() {
            sidebar.classList.remove('open');
            mobileOverlay.classList.remove('show');
        }
        document.getElementById('menuBtnMobile').addEventListener('click', toggleMobileMenu);
        document.getElementById('menuBtnMobile2').addEventListener('click', toggleMobileMenu);
        mobileOverlay.addEventListener('click', closeMobileMenu);

        // ëª¨ë“œ ì „í™˜
        if (newMemoBtn) newMemoBtn.addEventListener('click', () => setToWriteMode());
        function setToWriteMode() {
            currentMode = 'write';
            editorHeader.style.display = 'none';
            editorFooter.style.display = 'flex';
            memoInput.style.display = 'block';
            memoViewer.style.display = 'none';
            memoInput.value = '';
            memoInput.focus();
            summaryOverlay.classList.remove('show');
            closeMobileMenu();
        }

        function setToReadMode(title, content) {
            currentMode = 'read';
            editorHeader.style.display = 'flex';
            editorFooter.style.display = 'none';
            viewTitle.textContent = title;
            memoInput.style.display = 'none';
            memoViewer.style.display = 'block';
            memoViewer.textContent = content.trim();
            summaryOverlay.classList.remove('show');
            closeMobileMenu();
        }

        // ì‚¬ì´ë“œë°” ë¡œë”© (ì¸ì¦ ì™„ë£Œ ì‹œ í˜¸ì¶œë¨)
        function initNoteModule() {
            loadSidebarData(g_userName);
            if (memoInput) memoInput.focus();
        }

        function loadSidebarData(userName) {
            if (!folderList) return;
            folderList.innerHTML = '<div class="loading-text">í´ë” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            if (searchInput) searchInput.value = '';
            google.script.run
                .withSuccessHandler((data) => {
                    cachedSidebarData = data;
                    renderSidebar(data);
                })
                .withFailureHandler((err) => {
                    folderList.innerHTML = `<div class="loading-text" style="color:var(--danger);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
                })
                .getArchivedMemos(userName);
        }

        if (searchInput) {
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (!query) return renderSidebar(cachedSidebarData);
                    folderList.innerHTML = '<div class="loading-text">ê²€ìƒ‰ ì¤‘... ğŸ”</div>';
                    google.script.run
                        .withSuccessHandler((results) => renderSearchResults(results, query))
                        .withFailureHandler(() => { folderList.innerHTML = '<div class="loading-text" style="color:var(--danger);">ê²€ìƒ‰ ì‹¤íŒ¨</div>'; })
                        .searchArchivedMemos(g_userName, query);
                }
            });
        }

        function renderSearchResults(results, query) {
            folderList.innerHTML = '';
            const clearBtn = document.createElement('div');
            clearBtn.className = 'loading-text';
            clearBtn.style.cursor = 'pointer';
            clearBtn.style.color = 'var(--primary)';
            clearBtn.textContent = 'â† í´ë” ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
            clearBtn.addEventListener('click', () => { searchInput.value = ''; renderSidebar(cachedSidebarData); });
            folderList.appendChild(clearBtn);

            if (!results || results.length === 0) {
                folderList.innerHTML += '<div class="loading-text">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            results.forEach(res => {
                const d = document.createElement('div');
                d.className = 'search-result-item';
                const dateDiv = document.createElement('div'); dateDiv.className = 'search-result-date'; dateDiv.textContent = `${res.date} ${res.time}`;
                const textDiv = document.createElement('div'); textDiv.className = 'search-result-text';
                const safeQuery = query.replace(/[.*+?^${ }()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${safeQuery})`, 'gi');
                let escapedContent = res.content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                escapedContent = escapedContent.replace(regex, '<span class="highlight">$1</span>');
                textDiv.innerHTML = escapedContent;
                d.appendChild(dateDiv); d.appendChild(textDiv);
                d.addEventListener('click', () => setToReadMode(res.date + " ê²€ìƒ‰ ê²°ê³¼", `- **[${res.time}]**\n  ${res.content}`));
                folderList.appendChild(d);
            });
        }

        function renderSidebar(data) {
            if (!data || data.length === 0) {
                folderList.innerHTML = '<div class="loading-text">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            folderList.innerHTML = '';
            data.forEach(monthData => {
                const folderDiv = document.createElement('div'); folderDiv.className = 'folder-item';
                const titleDiv = document.createElement('div'); titleDiv.className = 'folder-title';
                titleDiv.innerHTML = `<span class="folder-icon">ğŸ“</span> ${monthData.month} ì—…ë¬´ì¼ì§€`;
                const childrenDiv = document.createElement('div'); childrenDiv.className = 'folder-children';

                monthData.days.forEach(dayData => {
                    const fileDiv = document.createElement('div'); fileDiv.className = 'file-item'; fileDiv.textContent = `ğŸ“„ ${dayData.date}`;
                    fileDiv.addEventListener('click', () => {
                        let combinedContent = "";
                        dayData.memos.forEach(m => { combinedContent += `- **[${m.time}]**\n  ${m.content}\n\n`; });
                        setToReadMode(dayData.date, combinedContent);
                    });
                    childrenDiv.appendChild(fileDiv);
                });

                titleDiv.addEventListener('click', () => folderDiv.classList.toggle('open'));
                folderDiv.appendChild(titleDiv); folderDiv.appendChild(childrenDiv);
                folderList.appendChild(folderDiv);
            });
            if (document.querySelector('.folder-item')) document.querySelector('.folder-item').classList.add('open');
        }

        // ì €ì¥ ë° AI ìš”ì•½
        if (saveBtn) saveBtn.addEventListener('click', () => saveMemo());
        if (closeSummaryBtn) closeSummaryBtn.addEventListener('click', () => summaryOverlay.classList.remove('show'));

        // ===== ğŸ° ë“œë˜ê·¸ ì„ íƒ í”Œë¡œíŒ… ë²„íŠ¼ ë¡œì§ =====
        let _selectedTextForTask = '';

        function handleTextSelection() {
            // ë…¸íŠ¸ íƒ­ì´ í™œì„± ìƒíƒœì¼ ë•Œë§Œ ì‘ë™
            if (!document.getElementById('viewNote').classList.contains('active')) return;

            const selection = window.getSelection();
            const text = selection.toString().trim();

            if (text.length < 5) {
                judyFloatBtn.style.display = 'none';
                _selectedTextForTask = '';
                return;
            }

            _selectedTextForTask = text;

            // ì„ íƒ ì˜ì—­ ìœ„ì¹˜ ê³„ì‚°
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            // ë²„íŠ¼ ìœ„ì¹˜: ì„ íƒ ì˜ì—­ ìƒë‹¨ ì¤‘ì•™
            const btnWidth = 120;
            let left = rect.left + (rect.width / 2) - (btnWidth / 2);
            let top = rect.top - 42;

            // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ë³´ì •
            if (left < 8) left = 8;
            if (left + btnWidth > window.innerWidth - 8) left = window.innerWidth - btnWidth - 8;
            if (top < 8) top = rect.bottom + 6;

            judyFloatBtn.style.left = left + 'px';
            judyFloatBtn.style.top = top + 'px';
            judyFloatBtn.style.display = 'flex';
        }

        // mouseup ì´ë²¤íŠ¸ë¡œ í…ìŠ¤íŠ¸ ì„ íƒ ê°ì§€ (ì½ê¸°/ì“°ê¸° ëª¨ë“œ ëª¨ë‘)
        document.addEventListener('mouseup', (e) => {
            // í”Œë¡œíŒ… ë²„íŠ¼ ìì²´ë¥¼ í´ë¦­í•œ ê²½ìš°ëŠ” ë¬´ì‹œ
            if (e.target === judyFloatBtn || judyFloatBtn.contains(e.target)) return;
            setTimeout(handleTextSelection, 10);
        });

        // ë‹¤ë¥¸ ê³³ í´ë¦­ ì‹œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        document.addEventListener('mousedown', (e) => {
            if (e.target === judyFloatBtn || judyFloatBtn.contains(e.target)) return;
            judyFloatBtn.style.display = 'none';
        });

        // í”Œë¡œíŒ… ë²„íŠ¼ í´ë¦­ ì‹œ AI íŒŒì‹± í›„ ëª¨ë‹¬ ì˜¤í”ˆ
        judyFloatBtn.addEventListener('click', () => {
            if (!_selectedTextForTask) return;
            if (!g_userName) return showToast('â›” ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.', true);

            judyFloatBtn.style.display = 'none';
            const selectedText = _selectedTextForTask;
            _selectedTextForTask = '';
            window.getSelection().removeAllRanges();

            showToast('ğŸ° AIê°€ ì„ íƒëœ ë‚´ìš©ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...');

            google.script.run
                .withSuccessHandler((res) => {
                    if (res && res.success && res.data) {
                        showToast('âœ¨ ì—…ë¬´ ì¶”ì¶œ ì™„ë£Œ! ë“±ë¡ í¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        switchMainView('tasks');
                        setTimeout(() => { openRegModal(res.data); }, 200);
                    } else {
                        showToast('âŒ ' + (res ? res.message : 'AI ë¶„ì„ ì‹¤íŒ¨'), true);
                    }
                })
                .withFailureHandler((err) => {
                    showToast('âŒ ì„œë²„ í†µì‹  ì—ëŸ¬', true);
                })
                .parseTaskFromMemoWeb(g_userName, selectedText);
        });

        function saveMemo() {
            const text = memoInput ? memoInput.value.trim() : '';
            if (!g_userName) return showToast('â›” ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.', true);
            if (!text) { if (memoInput) memoInput.focus(); return; }

            saveBtn.disabled = true;
            const prevSave = saveBtn.textContent;
            saveBtn.textContent = "ì €ì¥ ì¤‘...";

            google.script.run
                .withSuccessHandler((res) => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = prevSave;
                    if (res && res.success) {
                        memoInput.value = "";
                        memoInput.focus();
                        loadSidebarData(g_userName);
                        showToast('âœ… ' + (res.message || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'));
                    } else {
                        showToast('âŒ ì—ëŸ¬: ' + (res ? res.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬'), true);
                    }
                })
                .withFailureHandler((err) => {
                    saveBtn.disabled = false;
                    saveBtn.textContent = prevSave;
                    showToast('âŒ ì„œë²„ í†µì‹  ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', true);
                })
                .saveFromWeb(g_userName, text);
        }

        if (summarizeBtn) summarizeBtn.addEventListener('click', () => {
            const text = memoViewer ? memoViewer.textContent.trim() : '';
            if (!text) return;
            summarizeBtn.disabled = true; summarizeBtn.textContent = "ìš”ì•½ ì¤‘... ğŸª„";
            google.script.run
                .withSuccessHandler((res) => {
                    summarizeBtn.disabled = false; summarizeBtn.textContent = "âœ¨ AI ë‚´ìš© ìš”ì•½";
                    if (res.success) { summaryContent.textContent = res.summary; summaryOverlay.classList.add('show'); }
                    else showToast("âŒ ìš”ì•½ ì‹¤íŒ¨: " + res.message, true);
                })
                .withFailureHandler(() => {
                    summarizeBtn.disabled = false; summarizeBtn.textContent = "âœ¨ AI ë‚´ìš© ìš”ì•½";
                    showToast("âŒ ì„œë²„ í†µì‹  ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
                })
                .summarizeMemoContent(text, g_userName);
        });

        // ==========================================
        // Tasks Dashboard Module Logic
        // ==========================================
        let currentTasks = [];
        let taskCurrentTab = 'active';
        let projectsLoaded = false;

        function initTasksModule() {
            // DashboardëŠ” ì´ˆê¸°ì— ë³´ì—¬ì§ˆ ë•Œ, í˜¹ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ í•œ ë²ˆë§Œ ë¡œë“œ
            loadTasks();
        }

        function loadTasks() {
            const listObj = document.getElementById('taskList');
            if (!listObj) return;
            listObj.innerHTML = '<div class="loading">ì—…ë¬´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            // web_app.gs ì˜ getMyTasksForWeb(userId) í˜¸ì¶œ
            // userIdê°€ ì—†ìœ¼ë©´ userNameì´ë¼ë„ ì „ë‹¬í•˜ì—¬ ì‹œíŠ¸ ì¡°íšŒ ë§¤ì¹­ ë³´ì¥
            google.script.run
                .withSuccessHandler(renderTasks)
                .withFailureHandler(err => {
                    listObj.innerHTML = `<div class="loading" style="color:var(--danger);">âŒ ì—…ë¬´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>${err.message}</div>`;
                })
                .getMyTasksForWeb(g_userId || g_userName);
        }

        function switchTaskTab(tab) {
            taskCurrentTab = tab;
            document.getElementById('tab-active').classList.toggle('active', tab === 'active');
            document.getElementById('tab-completed').classList.toggle('active', tab === 'completed');
            renderTaskTable();
        }

        function renderTasks(tasks) {
            currentTasks = tasks || [];
            if (!tasks || tasks.length === 0) {
                document.getElementById('summaryBar').innerHTML = '';
                document.getElementById('tabsBar').style.display = 'none';
                document.getElementById('taskList').innerHTML =
                    '<div class="empty-state"><div class="emoji">ğŸ‰</div><p>ë“±ë¡ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤!</p></div>';
                return;
            }

            document.getElementById('tabsBar').style.display = 'flex';

            const counts = { 'ì§„í–‰ì¤‘': 0, 'ëŒ€ê¸°': 0, 'ë³´ë¥˜': 0, 'ì™„ë£Œ': 0 };
            tasks.forEach(t => { if (counts[t.status] !== undefined) counts[t.status]++; });
            const activeCount = counts['ì§„í–‰ì¤‘'] + counts['ëŒ€ê¸°'] + counts['ë³´ë¥˜'];

            // [Phase 21] ì˜¤ëŠ˜ ì´ ëª°ì… ì‹œê°„ ê³„ì‚° (ê´€ë¦¬ì ì „ìš©)
            let totalFocusMin = 0;
            if (window.isAdmin) {
                tasks.forEach(t => {
                    if (t.durationMin) totalFocusMin += t.durationMin;
                });
            }
            const focusHours = Math.floor(totalFocusMin / 60);
            const focusMin = totalFocusMin % 60;

            let summaryHtml = `
                <div class="summary-card"><div class="count count-total">${activeCount}</div><div class="label">ì „ì²´ (ì§„í–‰ì¤‘)</div></div>
                <div class="summary-card"><div class="count count-progress">${counts['ì§„í–‰ì¤‘']}</div><div class="label">â–¶ ì§„í–‰ì¤‘</div></div>
                <div class="summary-card"><div class="count count-waiting">${counts['ëŒ€ê¸°']}</div><div class="label">â¸ ëŒ€ê¸°</div></div>
                <div class="summary-card"><div class="count count-hold">${counts['ë³´ë¥˜']}</div><div class="label">ğŸ”´ ë³´ë¥˜</div></div>
                <div class="summary-card" style="border-left:1px solid var(--border); border-radius:0;"><div class="count" style="color:var(--primary);">${counts['ì™„ë£Œ']}</div><div class="label">âœ… ì™„ë£Œ</div></div>
            `;

            if (window.isAdmin) {
                summaryHtml += `
                    <div class="summary-card" style="border-left: 2px solid var(--danger); background: rgba(255, 82, 82, 0.05);">
                        <div class="count count-focus">${focusHours}h ${focusMin}m</div>
                        <div class="label">ğŸ”¥ ì˜¤ëŠ˜ì˜ ëª°ì…</div>
                    </div>
                `;
            }

            document.getElementById('summaryBar').innerHTML = summaryHtml;
            renderTaskTable();
        }

        function renderTaskTable() {
            let filteredTasks = currentTasks;
            if (taskCurrentTab === 'active') {
                filteredTasks = currentTasks.filter(t => t.status !== 'ì™„ë£Œ');
            } else {
                filteredTasks = currentTasks.filter(t => t.status === 'ì™„ë£Œ');
            }

            if (filteredTasks.length === 0) {
                document.getElementById('taskList').innerHTML =
                    '<div class="empty-state"><div class="emoji">ğŸ‰</div><p>í•´ë‹¹ íƒ­ì— ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤!</p></div>';
                return;
            }

            let html = `<table class="task-table">
                <thead><tr>
                    <th>ID</th><th>ì—…ë¬´ ì œëª©</th><th>í”„ë¡œì íŠ¸</th><th>ë§ˆê°ì¼</th><th>ìƒíƒœ</th><th>ë³€ê²½</th>
                </tr></thead><tbody>`;

            filteredTasks.forEach(t => {
                const dueHtml = getDueHtml(t.dDays, t.dueDate, t.status);

                // [Phase 21] ì†Œìš” ì‹œê°„ ë±ƒì§€ ìƒì„± (ê´€ë¦¬ì ì „ìš©)
                let durationBadge = '';
                if (window.isAdmin) {
                    if (t.status === 'ì™„ë£Œ' && t.durationMin) {
                        const h = Math.floor(t.durationMin / 60);
                        const m = t.durationMin % 60;
                        durationBadge = `<div class="duration-badge">â±ï¸ ${h > 0 ? h + 'h ' : ''}${m}m ì†Œìš”</div>`;
                    } else if (t.status === 'ì§„í–‰ì¤‘' && t.startTime) {
                        const elapsedMs = new Date() - new Date(t.startTime);
                        const elapsedMin = Math.floor(elapsedMs / (1000 * 60));
                        const h = Math.floor(elapsedMin / 60);
                        const m = elapsedMin % 60;
                        durationBadge = `<div class="duration-badge duration-active">ğŸ”¥ ${h > 0 ? h + 'h ' : ''}${m}m ëŒíŒŒ ì¤‘</div>`;
                    }
                }

                html += `<tr id="row-${t.row}" class="clickable-row" onclick="openEditModal(${t.row})">
                    <td style="font-weight:600; color:var(--primary);">${t.id || '-'}</td>
                    <td>
                        <div>${t.title}</div>
                        ${durationBadge}
                    </td>
                    <td style="color:var(--hint-color); font-size:13px;">${t.project}</td>
                    <td>${dueHtml}</td>
                    <td><span class="status-badge badge-${t.status}">${getStatusEmoji(t.status)} ${t.status}</span></td>
                    <td onclick="event.stopPropagation()">
                        <select class="status-select" onchange="changeTaskStatus(${t.row}, this.value, '${t.id}')">
                            <option value="ì§„í–‰ì¤‘" ${t.status === 'ì§„í–‰ì¤‘' ? 'selected' : ''}>â–¶ ì§„í–‰ì¤‘</option>
                            <option value="ëŒ€ê¸°" ${t.status === 'ëŒ€ê¸°' ? 'selected' : ''}>â¸ ëŒ€ê¸°</option>
                            <option value="ë³´ë¥˜" ${t.status === 'ë³´ë¥˜' ? 'selected' : ''}>ğŸ”´ ë³´ë¥˜</option>
                            <option value="ì™„ë£Œ" ${t.status === 'ì™„ë£Œ' ? 'selected' : ''}>âœ… ì™„ë£Œ</option>
                        </select>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('taskList').innerHTML = html;
        }

        function getDueHtml(dDays, dueDate, status) {
            if (status === 'ì™„ë£Œ') return '<span class="due-tag due-normal">âœ… ë§ˆê°ë¨</span>';
            if (dDays === null || dDays === undefined) return '<span class="due-tag due-normal">-</span>';
            if (dDays < 0) return `<span class="due-tag due-overdue">ğŸš¨ ${Math.abs(dDays)}ì¼ ì´ˆê³¼</span>`;
            if (dDays === 0) return `<span class="due-tag due-today">ğŸ”¥ ì˜¤ëŠ˜!</span>`;
            if (dDays === 1) return `<span class="due-tag due-tomorrow">âš ï¸ ë‚´ì¼</span>`;
            return `<span class="due-tag due-normal">ğŸ“… ${dueDate}</span>`;
        }

        function getStatusEmoji(s) {
            return s === 'ì§„í–‰ì¤‘' ? 'â–¶' : s === 'ëŒ€ê¸°' ? 'â¸' : s === 'ë³´ë¥˜' ? 'ğŸ”´' : 'âœ…';
        }

        function changeTaskStatus(row, newStatus, taskId) {
            showToast('â³ ìƒíƒœ ë³€ê²½ ì¤‘...');
            google.script.run
                .withSuccessHandler(res => {
                    if (res.success) {
                        showToast('âœ… ' + (taskId || '') + ' â†’ ' + newStatus + ' ì™„ë£Œ!');
                        if (newStatus === 'ì™„ë£Œ') loadTasks();
                    } else { showToast('âŒ ' + res.message, true); }
                })
                .withFailureHandler(err => showToast('âŒ ' + err.message, true))
                .changeTaskStatusFromWeb(row, newStatus);
        }

        // ==========================================
        // Modal Control
        // ==========================================
        function openRegModal(prefillData = null) {
            document.getElementById('regModalOverlay').classList.add('show');
            document.getElementById('formTitle').value = '';
            document.getElementById('formDesc').value = '';
            document.getElementById('formDue').value = '';
            document.getElementById('formStatus').value = 'ëŒ€ê¸°';

            // [Phase 4] ì¶”ì¶œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í¼ì— ì±„ì›Œë„£ê¸°
            if (prefillData) {
                if (prefillData.title) document.getElementById('formTitle').value = prefillData.title;
                if (prefillData.desc) document.getElementById('formDesc').value = prefillData.desc;
                if (prefillData.due) document.getElementById('formDue').value = prefillData.due;
            }

            if (!projectsLoaded) loadProjectsList();
        }
        function closeRegModal() { document.getElementById('regModalOverlay').classList.remove('show'); }

        function loadProjectsList() {
            google.script.run
                .withSuccessHandler(projects => {
                    const sel = document.getElementById('formProject');
                    sel.innerHTML = '';
                    projects.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.value; opt.textContent = p.text.text || p.text;
                        sel.appendChild(opt);
                    });
                    projectsLoaded = true;
                })
                .withFailureHandler(err => {
                    document.getElementById('formProject').innerHTML = '<option>ì§€í‘œ ë¡œë“œ ì‹¤íŒ¨</option>';
                })
                .getProjectOptionsForWeb();
        }

        function submitNewTask() {
            const projectSel = document.getElementById('formProject');
            const projectCode = projectSel.value;
            const projectName = projectCode ? projectSel.options[projectSel.selectedIndex].text : "";
            const title = document.getElementById('formTitle').value.trim();
            const desc = document.getElementById('formDesc').value.trim();
            const due = document.getElementById('formDue').value;
            const status = document.getElementById('formStatus').value;

            if (!title) return showToast('âŒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', true);

            const btn = document.getElementById('submitRegBtn');
            btn.disabled = true; btn.textContent = 'ë“±ë¡ ì¤‘...';

            google.script.run
                .withSuccessHandler(res => {
                    btn.disabled = false; btn.textContent = 'ë“±ë¡í•˜ê¸°';
                    if (res.success) {
                        showToast('âœ… ' + res.message);
                        closeRegModal(); loadTasks();
                    } else { showToast('âŒ ' + res.message, true); }
                })
                .withFailureHandler(err => {
                    btn.disabled = false; btn.textContent = 'ë“±ë¡í•˜ê¸°';
                    showToast('âŒ ' + err.message, true);
                })
                .registerTaskFromWeb(g_userId || g_userName, projectCode, projectName, title, desc, due, status);
        }

        // === ì—…ë¬´ ìƒì„¸/ìˆ˜ì • ëª¨ë‹¬ ===
        function openEditModal(rowNum) {
            const task = currentTasks.find(t => t.row === rowNum);
            if (!task) return;
            document.getElementById('editRowNum').value = task.row;
            document.getElementById('editTitle').value = task.title || '';
            document.getElementById('editDesc').value = task.desc || '';
            document.getElementById('editDue').value = task.rawDueStr || '';
            document.getElementById('editStatus').value = task.status || 'ëŒ€ê¸°';
            document.getElementById('editModalOverlay').classList.add('show');
        }
        function closeEditModal() { document.getElementById('editModalOverlay').classList.remove('show'); }

        function submitEditedTask() {
            const rowNum = parseInt(document.getElementById('editRowNum').value, 10);
            const title = document.getElementById('editTitle').value.trim();
            const desc = document.getElementById('editDesc').value.trim();
            const due = document.getElementById('editDue').value;
            const status = document.getElementById('editStatus').value;

            if (!title) return showToast('âŒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', true);

            const btn = document.getElementById('submitEditBtn');
            btn.disabled = true; btn.textContent = 'ìˆ˜ì • ì¤‘...';

            google.script.run
                .withSuccessHandler(res => {
                    btn.disabled = false; btn.textContent = 'ìˆ˜ì •í•˜ê¸°';
                    if (res.success) {
                        showToast('âœ… ' + res.message);
                        closeEditModal(); loadTasks();
                    } else { showToast('âŒ ' + res.message, true); }
                })
                .withFailureHandler(err => {
                    btn.disabled = false; btn.textContent = 'ìˆ˜ì •í•˜ê¸°';
                    showToast('âŒ ' + err.message, true);
                })
                .updateTaskFromWeb(rowNum, title, desc, due, status);
        }

    </script>
</body>

</html>