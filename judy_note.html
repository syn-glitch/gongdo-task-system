<!DOCTYPE html>
<!-- 
  * [íŒŒì¼ëª…]: judy_note.html
  * [ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸]: 2026-02-22 13:21 (KST)
  * [ê¸°ëŠ¥]: ì›¹ ê¸°ë°˜ ë©”ëª¨ì¥ UI. êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë”, ë‹¤í¬/ë¼ì´íŠ¸ í…Œë§ˆ í† ê¸€, ì½ê¸°/ì“°ê¸° ëª¨ë“œ, AI íŒì—… ìš”ì•½ ê¸°ëŠ¥ í¬í•¨ 
-->
<html data-theme="dark">

<head>
  <base target="_top">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for Theming */
    :root[data-theme="dark"] {
      --bg-color: #121212;
      --sidebar-bg: #1e1e1e;
      --sidebar-border: #333333;
      --text-color: #E0E0E0;
      --hint-color: #888888;
      --primary: #bb86fc;
      --surface: #2c2c2c;
      --folder-hover: #3a3a3a;
      --btn-bg: #333333;
      --btn-text: #ffffff;
      --toast-bg: #333333;
      --toast-text: #ffffff;
    }

    :root[data-theme="light"] {
      --bg-color: #f9f9f9;
      --sidebar-bg: #f0f0f0;
      --sidebar-border: #e0e0e0;
      --text-color: #212121;
      --hint-color: #666666;
      --primary: #6200ee;
      --surface: #ffffff;
      --folder-hover: #e0e0e0;
      --btn-bg: #e0e0e0;
      --btn-text: #212121;
      --toast-bg: #323232;
      --toast-text: #ffffff;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Pretendard', sans-serif;
      overflow: hidden;
      display: flex;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      min-width: 280px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--sidebar-border);
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s;
    }

    .sidebar-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--sidebar-border);
    }

    .sidebar-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .new-btn {
      background: transparent;
      border: 1px solid var(--sidebar-border);
      color: var(--text-color);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .new-btn:hover {
      background: var(--surface);
      border-color: var(--primary);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
    }

    /* Folder accodion styles */
    .folder-item {
      display: flex;
      flex-direction: column;
    }

    .folder-title {
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .folder-title:hover {
      background-color: var(--folder-hover);
    }

    .folder-icon {
      font-size: 16px;
    }

    .folder-children {
      display: none;
      flex-direction: column;
      padding-left: 20px;
      background: rgba(0, 0, 0, 0.02);
    }

    .folder-item.open .folder-children {
      display: flex;
    }

    .file-item {
      padding: 8px 20px 8px 30px;
      font-size: 13px;
      color: var(--text-color);
      cursor: pointer;
    }

    .file-item:hover {
      background-color: var(--folder-hover);
      color: var(--primary);
    }

    .loading-text {
      padding: 20px;
      font-size: 13px;
      color: var(--hint-color);
      text-align: center;
    }

    /* Search UI */
    .sidebar-search {
      padding: 10px 20px;
      border-bottom: 1px solid var(--sidebar-border);
    }

    .sidebar-search input {
      width: 100%;
      background: var(--surface);
      color: var(--text-color);
      border: 1px solid var(--sidebar-border);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    .sidebar-search input:focus {
      border-color: var(--primary);
    }

    .sidebar-search input::placeholder {
      color: var(--hint-color);
    }

    .search-result-item {
      padding: 12px 20px;
      border-bottom: 1px solid var(--sidebar-border);
      cursor: pointer;
    }

    .search-result-item:hover {
      background-color: var(--folder-hover);
    }

    .search-result-date {
      font-size: 12px;
      color: var(--primary);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .search-result-text {
      font-size: 13px;
      color: var(--text-color);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      /* ìµœëŒ€ 3ì¤„ê¹Œì§€ë§Œ ë³´ì´ê¸° */
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .highlight {
      background-color: rgba(187, 134, 252, 0.4);
      color: var(--text-color);
      border-radius: 2px;
      padding: 0 2px;
    }

    html[data-theme="light"] .highlight {
      background-color: rgba(98, 0, 238, 0.2);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--bg-color);
      transition: background-color 0.3s;
    }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 16px 24px;
      height: 40px;
      gap: 12px;
    }

    .theme-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      outline: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .theme-btn:hover {
      background-color: var(--surface);
    }

    .user-select {
      background: var(--surface);
      color: var(--text-color);
      border: 1px solid var(--sidebar-border);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }

    .user-select:focus {
      border-color: var(--primary);
    }

    /* Editor View Header */
    .editor-header {
      padding: 0 40px 10px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid transparent;
    }

    .editor-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      color: var(--text-color);
    }

    /* Main Editor */
    .editor-container {
      flex: 1;
      padding: 20px 40px 40px 40px;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-color);
      font-size: 18px;
      line-height: 1.6;
      resize: none;
      outline: none;
      font-family: 'Pretendard', sans-serif;
      caret-color: var(--primary);
    }

    textarea[readonly] {
      color: var(--hint-color);
      /* ì•½ê°„ íë¦¬ê²Œ */
    }

    textarea::placeholder {
      color: var(--hint-color);
    }

    /* AI Summary Overlay */
    .summary-overlay {
      position: absolute;
      top: 20px;
      left: 40px;
      right: 40px;
      background: var(--surface);
      border: 1px solid var(--primary);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      transform: translateY(-10px);
    }

    .summary-overlay.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .summary-title {
      font-weight: 600;
      color: var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .close-summary {
      background: transparent;
      border: none;
      color: var(--hint-color);
      cursor: pointer;
      font-size: 18px;
    }

    .summary-content {
      font-size: 15px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    /* Footer / Keyboard Hint */
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 40px 20px 40px;
      color: var(--hint-color);
      font-size: 13px;
    }

    .footer-buttons {
      display: flex;
      gap: 12px;
    }

    .save-btn,
    .action-btn {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }

    .extract-btn,
    .action-btn-primary {
      background: linear-gradient(135deg, #bb86fc, #3700b3);
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      box-shadow: 0 4px 12px rgba(187, 134, 252, 0.3);
    }

    html[data-theme="light"] .extract-btn,
    html[data-theme="light"] .action-btn-primary {
      background: linear-gradient(135deg, #6200ee, #3700b3);
      box-shadow: 0 4px 12px rgba(98, 0, 238, 0.3);
    }

    .save-btn:hover,
    .extract-btn:hover,
    .action-btn:hover,
    .action-btn-primary:hover {
      opacity: 0.9;
    }

    .save-btn:active,
    .extract-btn:active,
    .action-btn:active,
    .action-btn-primary:active {
      transform: scale(0.97);
    }

    .save-btn:disabled,
    .extract-btn:disabled,
    .action-btn:disabled,
    .action-btn-primary:disabled {
      background: var(--btn-bg);
      color: var(--hint-color);
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.6;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--toast-bg);
      color: var(--toast-text);
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: pre-wrap;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
      flex-shrink: 0;
    }
  </style>
</head>

<body>

  <div class="app-container">
    <!-- Left Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>ë‚´ í´ë”</h3>
        <button id="newMemoBtn" class="new-btn">+ ìƒˆ ë©”ëª¨</button>
      </div>
      <div class="sidebar-search">
        <input type="text" id="searchInput" placeholder="í‚¤ì›Œë“œ/íƒœê·¸ ê²€ìƒ‰ (Enter)" autocomplete="off" />
      </div>
      <div class="sidebar-content" id="folderList">
        <div class="loading-text">ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ë©´ ê¸°ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="top-bar">
        <button id="themeToggleBtn" class="theme-btn" title="í…Œë§ˆ ë³€ê²½">â˜€ï¸</button>
        <select id="userSelect" class="user-select">
          <option value="" disabled selected>ì‘ì„±ì ì„ íƒ</option>
          <option value="ì†¡ìš©ë‚¨">ì†¡ìš©ë‚¨</option>
          <option value="ì´ì§€ì€">ì´ì§€ì€</option>
          <option value="ê¹€ê°œë°œ">ê¹€ê°œë°œ</option>
        </select>
      </div>

      <!-- Editor Header (Visible when viewing past memo) -->
      <div class="editor-header" id="editorHeader" style="display: none;">
        <h2 id="viewTitle">ì½ê¸° ëª¨ë“œ</h2>
        <button id="summarizeBtn" class="action-btn-primary">âœ¨ AI ë‚´ìš© ìš”ì•½</button>
      </div>

      <div class="editor-container">
        <!-- AI Summary Overlay -->
        <div class="summary-overlay" id="summaryOverlay">
          <div class="summary-title">
            <span>âœ¨ AI ìš”ì•½ ê²°ê³¼</span>
            <button class="close-summary" id="closeSummaryBtn">âœ•</button>
          </div>
          <div class="summary-content" id="summaryContent">ìš”ì•½ëœ ë‚´ìš©ì´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
        </div>

        <textarea id="memoInput"
          placeholder="ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼ ì—¬ê¸°ì— ìŸì•„ë‚´ì„¸ìš”...&#10;(ì¼ë°˜ ì €ì¥ ì‹œ ë“œë¼ì´ë¸Œì—ë§Œ ë°±ì—…ë˜ë©°, AI ì—…ë¬´ ì¶”ì¶œ ì‹œ ì—‘ì…€ê¹Œì§€ ë“±ë¡ë©ë‹ˆë‹¤)"></textarea>
      </div>

      <!-- Footer (Visible when writing new memo) -->
      <div class="footer" id="editorFooter">
        <span class="hint">ì €ì¥: Cmd + Enter (ë˜ëŠ” Ctrl + Enter)</span>
        <div class="footer-buttons">
          <button id="saveBtn" class="save-btn">ì¼ë°˜ ì €ì¥</button>
          <button id="extractBtn" class="extract-btn">âœ¨ AI ì—…ë¬´ ì¶”ì¶œ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <div class="status-dot" id="toastStatus"></div>
    <span id="toastMsg">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
  </div>

  <script>
    const memoInput = document.getElementById('memoInput');
    const userSelect = document.getElementById('userSelect');
    const saveBtn = document.getElementById('saveBtn');
    const extractBtn = document.getElementById('extractBtn');
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    const toastStatus = document.getElementById('toastStatus');

    // Theme Elements
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const htmlEl = document.documentElement;

    // Layout Elements
    const folderList = document.getElementById('folderList');
    const newMemoBtn = document.getElementById('newMemoBtn');
    const editorHeader = document.getElementById('editorHeader');
    const editorFooter = document.getElementById('editorFooter');
    const viewTitle = document.getElementById('viewTitle');
    const summarizeBtn = document.getElementById('summarizeBtn');
    const summaryOverlay = document.getElementById('summaryOverlay');
    const summaryContent = document.getElementById('summaryContent');
    const closeSummaryBtn = document.getElementById('closeSummaryBtn');

    // State Variable
    let currentMode = 'write'; // 'write' or 'read'
    let currentHtmlTheme = 'dark';
    let cachedSidebarData = null; // ê²€ìƒ‰ ì·¨ì†Œ ì‹œ ë³µêµ¬í•  ì›ë˜ í´ë” ë¦¬ìŠ¤íŠ¸ ë°ì´í„°
    const searchInput = document.getElementById('searchInput');

    // ==========================================
    // 0. í…Œë§ˆ ê´€ë¦¬ (Light / Dark)
    // ==========================================
    const savedTheme = localStorage.getItem('judy_note_theme') || 'dark';
    setTheme(savedTheme);

    themeToggleBtn.addEventListener('click', () => {
      const newTheme = currentHtmlTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });

    function setTheme(theme) {
      currentHtmlTheme = theme;
      htmlEl.setAttribute('data-theme', theme);
      themeToggleBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      localStorage.setItem('judy_note_theme', theme);
    }

    // ==========================================
    // 1. ìœ ì € ì •ë³´ ë° ì‚¬ì´ë“œë°” ì—°ë™
    // ==========================================
    const savedUser = localStorage.getItem('judy_note_user');
    if (savedUser) {
      userSelect.value = savedUser;
      loadSidebarData(savedUser);
    }

    userSelect.addEventListener('change', (e) => {
      const userName = e.target.value;
      localStorage.setItem('judy_note_user', userName);
      setToWriteMode(); // ì‘ì„± ëª¨ë“œë¡œ ë¦¬ì…‹
      loadSidebarData(userName);
    });

    // ==========================================
    // 2. ëª¨ë“œ ì „í™˜ (Write <-> Read)
    // ==========================================
    newMemoBtn.addEventListener('click', () => {
      setToWriteMode();
    });

    function setToWriteMode() {
      currentMode = 'write';
      editorHeader.style.display = 'none';
      editorFooter.style.display = 'flex';
      memoInput.readOnly = false;
      memoInput.value = '';
      memoInput.focus();
      summaryOverlay.classList.remove('show');
    }

    function setToReadMode(title, content) {
      currentMode = 'read';
      editorHeader.style.display = 'flex';
      editorFooter.style.display = 'none';
      viewTitle.textContent = title;
      memoInput.readOnly = true;
      memoInput.value = content.trim();
      summaryOverlay.classList.remove('show'); // í˜¹ì‹œ ì—´ë ¤ìˆë˜ ìš”ì•½ì°½ ë‹«ê¸°
    }

    // ==========================================
    // 3. ì‚¬ì´ë“œë°” ë Œë”ë§ ë° ê²€ìƒ‰ í•¸ë“¤ë§
    // ==========================================
    function loadSidebarData(userName) {
      folderList.innerHTML = '<div class="loading-text">í´ë” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
      if (searchInput) searchInput.value = ''; // ì´ˆê¸°í™”

      google.script.run
        .withSuccessHandler((data) => {
          try {
            cachedSidebarData = data;
            renderSidebar(data);
          } catch (err) {
            console.error("Render Error:", err);
            folderList.innerHTML = '<div class="loading-text" style="color:#f44336;">ì‚¬ì´ë“œë°” ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
          }
        })
        .withFailureHandler((err) => {
          console.error("Backend Error:", err);
          folderList.innerHTML = `<div class="loading-text" style="color:#f44336;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>(${err.message})</div>`;
        })
        .getArchivedMemos(userName); // Backend í•¨ìˆ˜
    }

    if (searchInput) {
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const query = e.target.value.trim();
          const userName = userSelect.value;
          if (!userName) return;

          if (query === '') {
            renderSidebar(cachedSidebarData);
            return;
          }

          // ê²€ìƒ‰ ëª¨ë“œ ì§„ì…
          folderList.innerHTML = '<div class="loading-text">ê²€ìƒ‰ ì¤‘... ğŸ”</div>';
          google.script.run
            .withSuccessHandler((results) => {
              renderSearchResults(results, query);
            })
            .withFailureHandler((err) => {
              folderList.innerHTML = '<div class="loading-text" style="color:#f44336;">ê²€ìƒ‰ ì‹¤íŒ¨</div>';
              console.error(err);
            })
            .searchArchivedMemos(userName, query);
        }
      });
    }

    function renderSearchResults(results, query) {
      folderList.innerHTML = '';

      const clearBtn = document.createElement('div');
      clearBtn.className = 'loading-text';
      clearBtn.style.cursor = 'pointer';
      clearBtn.style.color = 'var(--primary)';
      clearBtn.style.fontWeight = '500';
      clearBtn.textContent = 'â† í´ë” ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        renderSidebar(cachedSidebarData);
      });
      folderList.appendChild(clearBtn);

      if (!results || results.length === 0) {
        const emptyInfo = document.createElement('div');
        emptyInfo.className = 'loading-text';
        emptyInfo.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        folderList.appendChild(emptyInfo);
        return;
      }

      results.forEach(res => {
        const d = document.createElement('div');
        d.className = 'search-result-item';

        const dateDiv = document.createElement('div');
        dateDiv.className = 'search-result-date';
        dateDiv.textContent = `${res.date} ${res.time}`;

        const textDiv = document.createElement('div');
        textDiv.className = 'search-result-text';

        // Highlight The Match
        const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${safeQuery})`, 'gi');
        // XSS ë°©ì–´ (ê°„ë‹¨í•œ escape í›„ highlight ì ìš©)
        let escapedContent = res.content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        escapedContent = escapedContent.replace(regex, '<span class="highlight">$1</span>');
        textDiv.innerHTML = escapedContent;

        d.appendChild(dateDiv);
        d.appendChild(textDiv);

        d.addEventListener('click', () => {
          // ê²€ìƒ‰ëœ ì›ë¬¸ì„ í´ë¦­í•˜ë©´ ìš°ì¸¡ ë·°ì–´ì— ë³´ì—¬ì¤Œ
          setToReadMode(res.date + " ê²€ìƒ‰ ê²°ê³¼", `- **[${res.time}]**\n  ${res.content}`);
        });

        folderList.appendChild(d);
      });
    }

    function renderSidebar(data) {
      // data: [{ month: "2026-02", days: [ { date: "2026-02-22 (ì¼)", memos: [ { time: "14:30 PM", content: "..." } ] } ] }]
      if (!data || data.length === 0) {
        folderList.innerHTML = '<div class="loading-text">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      folderList.innerHTML = '';
      data.forEach(monthData => {
        const folderDiv = document.createElement('div');
        folderDiv.className = 'folder-item';

        const titleDiv = document.createElement('div');
        titleDiv.className = 'folder-title';
        titleDiv.innerHTML = `<span class="folder-icon">ğŸ“</span> ${monthData.month} ì—…ë¬´ì¼ì§€`;

        const childrenDiv = document.createElement('div');
        childrenDiv.className = 'folder-children';

        monthData.days.forEach(dayData => {
          // í•˜ìœ„ í´ë”: ë‚ ì§œë³„ ë¬¶ìŒ (ë˜ëŠ” íŒŒì¼ ë¦¬ìŠ¤íŠ¸)
          const fileDiv = document.createElement('div');
          fileDiv.className = 'file-item';
          fileDiv.textContent = `ğŸ“„ ${dayData.date}`;
          fileDiv.addEventListener('click', () => {
            // í•´ë‹¹ ë‚ ì§œ í´ë¦­ ì‹œ ëª¨ë“  ë©”ëª¨ ì·¨í•©í•´ì„œ ì½ê¸° ëª¨ë“œë¡œ ì§„ì…
            let combinedContent = "";
            dayData.memos.forEach(m => {
              combinedContent += `- **[${m.time}]**\n  ${m.content}\n\n`;
            });
            setToReadMode(dayData.date, combinedContent);
          });
          childrenDiv.appendChild(fileDiv);
        });

        titleDiv.addEventListener('click', () => {
          folderDiv.classList.toggle('open');
        });

        folderDiv.appendChild(titleDiv);
        folderDiv.appendChild(childrenDiv);
        folderList.appendChild(folderDiv);
      });

      // ì²« ë²ˆì§¸ í´ë”ëŠ” ê¸°ë³¸ ì—´ì–´ë‘ê¸°
      if (document.querySelector('.folder-item')) {
        document.querySelector('.folder-item').classList.add('open');
      }
    }

    // ==========================================
    // 4. ìƒˆ ë©”ëª¨ ì €ì¥ / ì—…ë¬´ ì¶”ì¶œ ë¡œì§
    // ==========================================
    memoInput.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        if (currentMode === 'write') {
          saveMemo('saveFromWeb');
        }
      }
    });

    saveBtn.addEventListener('click', () => saveMemo('saveFromWeb'));
    extractBtn.addEventListener('click', () => saveMemo('extractFromWeb'));

    function showToast(message, isError = false) {
      toastMsg.textContent = message;
      toastStatus.style.background = isError ? '#f44336' : '#4caf50';
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 5000);
    }

    function saveMemo(actionName) {
      const text = memoInput.value.trim();
      const userName = userSelect.value;
      const isExtract = actionName === 'extractFromWeb';

      if (!userName) {
        showToast("ìš°ì¸¡ ìƒë‹¨ì—ì„œ ì‘ì„±ìë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!", true);
        userSelect.focus();
        return;
      }

      if (!text) {
        memoInput.focus();
        return;
      }

      // UI ìƒíƒœ ë³€ê²½ (ì €ì¥ ì¤‘)
      saveBtn.disabled = true;
      extractBtn.disabled = true;
      memoInput.disabled = true;

      const prevSaveText = saveBtn.textContent;
      const prevExtractText = extractBtn.textContent;

      if (isExtract) {
        extractBtn.textContent = "AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸª„";
      } else {
        saveBtn.textContent = "ì €ì¥ ì¤‘...";
      }

      const runner = google.script.run
        .withSuccessHandler((res) => {
          saveBtn.disabled = false;
          extractBtn.disabled = false;
          saveBtn.textContent = prevSaveText;
          extractBtn.textContent = prevExtractText;
          memoInput.disabled = false;

          if (res && res.success) {
            memoInput.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
            showToast(res.message);
            memoInput.focus();

            // ì‚¬ì´ë“œë°” ì‹¤ì‹œê°„ ê°±ì‹  (ì €ì¥ ì¦‰ì‹œ ê°±ì‹ )
            loadSidebarData(userName);
          } else {
            showToast("âŒ ì—ëŸ¬: " + (res ? res.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬"), true);
          }
        })
        .withFailureHandler((err) => {
          saveBtn.disabled = false;
          extractBtn.disabled = false;
          saveBtn.textContent = prevSaveText;
          extractBtn.textContent = prevExtractText;
          memoInput.disabled = false;
          showToast("âŒ ì„œë²„ í†µì‹  ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
          console.error("Save Error:", err);
        });

      if (actionName === 'saveFromWeb') {
        runner.saveFromWeb(userName, text);
      } else {
        runner.extractFromWeb(userName, text);
      }
    }

    // ==========================================
    // 5. ëª¨ë‹¬ í˜•íƒœ AI ìš”ì•½
    // ==========================================
    closeSummaryBtn.addEventListener('click', () => {
      summaryOverlay.classList.remove('show');
    });

    summarizeBtn.addEventListener('click', () => {
      const text = memoInput.value.trim();
      const userName = userSelect.value;

      if (!text) return;

      summarizeBtn.disabled = true;
      summarizeBtn.textContent = "ìš”ì•½ ì¤‘... ğŸª„";

      google.script.run
        .withSuccessHandler((res) => {
          summarizeBtn.disabled = false;
          summarizeBtn.textContent = "âœ¨ AI ë‚´ìš© ìš”ì•½";

          if (res.success) {
            summaryContent.textContent = res.summary;
            summaryOverlay.classList.add('show');
          } else {
            showToast("âŒ ìš”ì•½ ì‹¤íŒ¨: " + res.message, true);
          }
        })
        .withFailureHandler((err) => {
          summarizeBtn.disabled = false;
          summarizeBtn.textContent = "âœ¨ AI ë‚´ìš© ìš”ì•½";
          showToast("âŒ ì„œë²„ í†µì‹  ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
        })
        .summarizeMemoContent(text, userName);
    });

    // ì´ˆê¸° í¬ì»¤ìŠ¤
    window.onload = () => {
      if (document.activeElement !== userSelect) {
        memoInput.focus();
      }
    };
  </script>
</body>

</html>