<!DOCTYPE html>
<!-- 
  * [íŒŒì¼ëª…]: judy_note.html
  * [ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸]: 2026-02-22 13:21 (KST)
  * [ê¸°ëŠ¥]: ì›¹ ê¸°ë°˜ ë©”ëª¨ì¥ UI. êµ¬ê¸€ ë“œë¼ì´ë¸Œ í´ë”, ë‹¤í¬/ë¼ì´íŠ¸ í…Œë§ˆ í† ê¸€, ì½ê¸°/ì“°ê¸° ëª¨ë“œ, AI íŒì—… ìš”ì•½ ê¸°ëŠ¥ í¬í•¨ 
-->
<html data-theme="dark">

<head>
  <base target="_top">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for Theming */
    :root[data-theme="dark"] {
      --bg-color: #121212;
      --sidebar-bg: #1e1e1e;
      --sidebar-border: #333333;
      --text-color: #E0E0E0;
      --hint-color: #888888;
      --primary: #bb86fc;
      --surface: #2c2c2c;
      --folder-hover: #3a3a3a;
      --btn-bg: #333333;
      --btn-text: #ffffff;
      --toast-bg: #333333;
      --toast-text: #ffffff;
    }

    :root[data-theme="light"] {
      --bg-color: #f9f9f9;
      --sidebar-bg: #f0f0f0;
      --sidebar-border: #e0e0e0;
      --text-color: #212121;
      --hint-color: #666666;
      --primary: #6200ee;
      --surface: #ffffff;
      --folder-hover: #e0e0e0;
      --btn-bg: #e0e0e0;
      --btn-text: #212121;
      --toast-bg: #323232;
      --toast-text: #ffffff;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Pretendard', sans-serif;
      overflow: hidden;
      display: flex;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      min-width: 280px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--sidebar-border);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease, background-color 0.3s;
      z-index: 100;
    }

    .sidebar-header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--sidebar-border);
    }

    .sidebar-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .new-btn {
      background: transparent;
      border: 1px solid var(--sidebar-border);
      color: var(--text-color);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .new-btn:hover {
      background: var(--surface);
      border-color: var(--primary);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px 0;
      min-height: 0;
    }

    /* Folder accodion styles */
    .folder-item {
      display: flex;
      flex-direction: column;
    }

    .folder-title {
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .folder-title:hover {
      background-color: var(--folder-hover);
    }

    .folder-icon {
      font-size: 16px;
    }

    .folder-children {
      display: none;
      flex-direction: column;
      padding-left: 20px;
      background: rgba(0, 0, 0, 0.02);
    }

    .folder-item.open .folder-children {
      display: flex;
    }

    .file-item {
      padding: 8px 20px 8px 30px;
      font-size: 13px;
      color: var(--text-color);
      cursor: pointer;
    }

    .file-item:hover {
      background-color: var(--folder-hover);
      color: var(--primary);
    }

    .loading-text {
      padding: 20px;
      font-size: 13px;
      color: var(--hint-color);
      text-align: center;
    }

    /* Search UI */
    .sidebar-search {
      padding: 10px 20px;
      border-bottom: 1px solid var(--sidebar-border);
    }

    .sidebar-search input {
      width: 100%;
      background: var(--surface);
      color: var(--text-color);
      border: 1px solid var(--sidebar-border);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    .sidebar-search input:focus {
      border-color: var(--primary);
    }

    .sidebar-search input::placeholder {
      color: var(--hint-color);
    }

    .search-result-item {
      padding: 12px 20px;
      border-bottom: 1px solid var(--sidebar-border);
      cursor: pointer;
    }

    .search-result-item:hover {
      background-color: var(--folder-hover);
    }

    .search-result-date {
      font-size: 12px;
      color: var(--primary);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .search-result-text {
      font-size: 13px;
      color: var(--text-color);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      /* ìµœëŒ€ 3ì¤„ê¹Œì§€ë§Œ ë³´ì´ê¸° */
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .highlight {
      background-color: rgba(187, 134, 252, 0.4);
      color: var(--text-color);
      border-radius: 2px;
      padding: 0 2px;
    }

    html[data-theme="light"] .highlight {
      background-color: rgba(98, 0, 238, 0.2);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--bg-color);
      transition: background-color 0.3s;
      min-height: 0;
    }

    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 16px 24px;
      height: 40px;
      gap: 12px;
    }

    /* Mobile Menu Button */
    .menu-btn {
      display: none;
      background: transparent;
      border: none;
      font-size: 24px;
      color: var(--text-color);
      cursor: pointer;
      margin-right: auto;
      /* Push other items to the right */
      padding: 4px;
    }

    .theme-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      outline: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    .theme-btn:hover {
      background-color: var(--surface);
    }

    .user-badge {
      background: var(--surface);
      color: var(--primary);
      border: 1px solid var(--primary);
      border-radius: 20px;
      padding: 6px 16px;
      font-size: 14px;
      font-weight: 600;
      user-select: none;
    }

    /* Access Denied Overlay */
    /* Access Denied Overlay */
    .access-denied-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: #fff;
      font-family: 'Pretendard', sans-serif;
    }

    .access-denied-overlay .icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .access-denied-overlay .title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .access-denied-overlay .desc {
      font-size: 15px;
      color: #aaa;
      text-align: center;
      line-height: 1.6;
    }

    /* Editor View Header */
    .editor-header {
      padding: 0 40px 10px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid transparent;
    }

    .editor-header h2 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      color: var(--text-color);
    }

    /* Main Editor */
    .editor-container {
      flex: 1;
      padding: 20px 40px 40px 40px;
      display: flex;
      flex-direction: column;
      position: relative;
      min-height: 0;
    }

    #memoInput {
      flex: 1;
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text-color);
      font-size: 15px;
      line-height: 1.6;
      font-family: 'Pretendard', sans-serif;
      resize: none;
      outline: none;
      padding: 0;
      overflow-y: auto;
      min-height: 0;
    }

    #memoInput::placeholder {
      color: var(--hint-color);
    }

    #memoViewer {
      flex: 1;
      width: 100%;
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-color);
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: 'Pretendard', sans-serif;
      min-height: 0;
    }

    /* AI Summary Overlay */
    .summary-overlay {
      position: absolute;
      top: 20px;
      left: 40px;
      right: 40px;
      background: var(--surface);
      border: 1px solid var(--primary);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      transform: translateY(-10px);
      max-height: 80%;
      overflow-y: auto;
    }

    .summary-overlay.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .summary-title {
      font-weight: 600;
      color: var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .close-summary {
      background: transparent;
      border: none;
      color: var(--hint-color);
      cursor: pointer;
      font-size: 18px;
    }

    .summary-content {
      font-size: 15px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    /* Footer / Keyboard Hint */
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 40px 20px 40px;
      color: var(--hint-color);
      font-size: 13px;
    }

    .footer-buttons {
      display: flex;
      gap: 12px;
    }

    .save-btn,
    .action-btn {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }

    .extract-btn,
    .action-btn-primary {
      background: linear-gradient(135deg, #bb86fc, #3700b3);
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      box-shadow: 0 4px 12px rgba(187, 134, 252, 0.3);
    }

    html[data-theme="light"] .extract-btn,
    html[data-theme="light"] .action-btn-primary {
      background: linear-gradient(135deg, #6200ee, #3700b3);
      box-shadow: 0 4px 12px rgba(98, 0, 238, 0.3);
    }

    .save-btn:hover,
    .extract-btn:hover,
    .action-btn:hover,
    .action-btn-primary:hover {
      opacity: 0.9;
    }

    .save-btn:active,
    .extract-btn:active,
    .action-btn:active,
    .action-btn-primary:active {
      transform: scale(0.97);
    }

    .save-btn:disabled,
    .extract-btn:disabled,
    .action-btn:disabled,
    .action-btn-primary:disabled {
      background: var(--btn-bg);
      color: var(--hint-color);
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.6;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--toast-bg);
      color: var(--toast-text);
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: pre-wrap;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
      flex-shrink: 0;
    }

    /* Mobile Overlay */
    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 90;
      transition: opacity 0.3s;
      opacity: 0;
      pointer-events: none;
    }

    .mobile-overlay.show {
      display: block;
      opacity: 1;
      pointer-events: auto;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .menu-btn {
        display: block;
      }

      .main-content {
        width: 100vw;
      }

      .editor-container {
        padding: 10px 20px 20px 20px;
      }

      .editor-header {
        padding: 0 20px 10px 20px;
      }

      .footer {
        padding: 0 20px 20px 20px;
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }

      .footer .hint {
        display: none;
        /* Hide keyboard shortcut hints on mobile */
      }

      .footer-buttons {
        justify-content: stretch;
      }

      .save-btn,
      .extract-btn {
        flex: 1;
        padding: 12px 16px;
        /* Larger touch targets */
      }

      .summary-overlay {
        left: 10px;
        right: 10px;
        top: 10px;
        padding: 16px;
      }
    }

    /* V2 Memo Block */
    .memo-block {
      padding: 16px;
      margin-bottom: 12px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 8px;
      border: 1px solid var(--sidebar-border);
      position: relative;
    }

    html[data-theme="dark"] .memo-block {
      background: rgba(255, 255, 255, 0.03);
    }

    .memo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .memo-time {
      font-weight: 600;
      color: var(--primary);
      font-size: 14px;
    }

    .action-buttons {
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .memo-block:hover .action-buttons,
    .memo-block.touched .action-buttons {
      opacity: 1;
    }

    .action-buttons button {
      background: transparent;
      border: 1px solid var(--sidebar-border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      transition: all 0.2s;
    }

    .action-buttons button:hover {
      background: var(--surface);
    }

    .action-buttons button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .action-delete.danger {
      color: #dc3545;
      border-color: rgba(220, 53, 69, 0.3);
    }

    .action-delete.danger:hover {
      background-color: #dc3545;
      color: white;
      border-color: #dc3545;
    }

    .memo-content {
      font-size: 15px;
      white-space: pre-wrap;
      line-height: 1.6;
      /* Ensure multiline fits well */
      word-break: break-all;
    }

    .memo-edit-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }

    .edit-input {
      width: 100%;
      min-height: 100px;
      background: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--primary);
      border-radius: 6px;
      padding: 12px;
      font-family: inherit;
      resize: vertical;
      box-sizing: border-box;
      outline: none;
    }

    .edit-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-save-sm,
    .btn-cancel-sm {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      border: none;
      font-weight: 500;
      transition: transform 0.1s, opacity 0.2s;
    }

    .btn-save-sm {
      background: var(--primary);
      color: white;
    }

    .btn-save-sm:hover {
      opacity: 0.9;
    }

    .btn-cancel-sm {
      background: transparent;
      color: var(--hint-color);
      border: 1px solid var(--sidebar-border);
    }

    .btn-cancel-sm:hover {
      background: var(--surface);
    }

    @media (max-width: 768px) {
      .action-buttons button {
        min-width: 44px;
        min-height: 44px;
        font-size: 18px;
      }
    }
  </style>
</head>

<body>

  <div class="app-container">
    <!-- Left Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>ë‚´ í´ë”</h3>
        <button id="newMemoBtn" class="new-btn">+ ìƒˆ ë©”ëª¨</button>
      </div>
      <div class="sidebar-search">
        <input type="text" id="searchInput" placeholder="í‚¤ì›Œë“œ/íƒœê·¸ ê²€ìƒ‰ (Enter)" autocomplete="off" />
      </div>
      <div class="sidebar-content" id="folderList">
        <div class="loading-text">ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ë©´ ê¸°ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="top-bar">
        <button id="menuBtn" class="menu-btn" title="ë©”ë‰´ ì—´ê¸°">â˜°</button>
        <button id="themeToggleBtn" class="theme-btn" title="í…Œë§ˆ ë³€ê²½">â˜€ï¸</button>
        <span id="userBadge" class="user-badge">ì¸ì¦ ì¤‘...</span>
      </div>

      <!-- Editor Header (Visible when viewing past memo) -->
      <div class="editor-header" id="editorHeader" style="display: none;">
        <h2 id="viewTitle">ì½ê¸° ëª¨ë“œ</h2>
        <button id="summarizeBtn" class="action-btn-primary">âœ¨ AI ë‚´ìš© ìš”ì•½</button>
      </div>

      <div class="editor-container">
        <!-- AI Summary Overlay -->
        <div class="summary-overlay" id="summaryOverlay">
          <div class="summary-title">
            <span>âœ¨ AI ìš”ì•½ ê²°ê³¼</span>
            <button class="close-summary" id="closeSummaryBtn">âœ•</button>
          </div>
          <div class="summary-content" id="summaryContent">ìš”ì•½ëœ ë‚´ìš©ì´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
        </div>

        <textarea id="memoInput"
          placeholder="ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼ ì—¬ê¸°ì— ìŸì•„ë‚´ì„¸ìš”...&#10;(ì¼ë°˜ ì €ì¥ ì‹œ ë“œë¼ì´ë¸Œì—ë§Œ ë°±ì—…ë˜ë©°, AI ì—…ë¬´ ì¶”ì¶œ ì‹œ ì—‘ì…€ê¹Œì§€ ë“±ë¡ë©ë‹ˆë‹¤)"></textarea>
        <div id="memoViewer" style="display:none;"></div>
      </div>

      <!-- Footer (Visible when writing new memo) -->
      <div class="footer" id="editorFooter">
        <span class="hint">ì €ì¥: Cmd + Enter (ë˜ëŠ” Ctrl + Enter)</span>
        <div class="footer-buttons">
          <button id="saveBtn" class="save-btn">ì¼ë°˜ ì €ì¥</button>
          <button id="extractBtn" class="extract-btn">âœ¨ AI ì—…ë¬´ ì¶”ì¶œ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <div class="status-dot" id="toastStatus"></div>
    <span id="toastMsg">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
  </div>

  <div id="mobileOverlay" class="mobile-overlay"></div>

  <!-- Access Denied Overlay (ì¸ì¦ ì‹¤íŒ¨ ì‹œ í‘œì‹œ) -->
  <div id="accessDeniedOverlay" class="access-denied-overlay" style="display: none;">
    <div class="icon">â›”</div>
    <div class="title">ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</div>
    <div class="desc" id="accessDeniedMsg">ë¹„ì •ìƒì ì¸ ì ‘ê·¼ì…ë‹ˆë‹¤.<br>ìŠ¬ë™ì—ì„œ ë‹¤ì‹œ ë§í¬ë¥¼ ë°œê¸‰ë°›ì•„ì£¼ì„¸ìš”.</div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="access-denied-overlay" style="display: none; z-index: 10000; padding: 20px;">
    <div
      style="background: var(--surface); padding: 24px; border-radius: 12px; width: 100%; max-width: 320px; color: var(--text-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
      <div class="title"
        style="color: #dc3545; margin-bottom: 12px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
        <span>âš ï¸</span> ë©”ëª¨ ì‚­ì œ
      </div>
      <div class="desc" id="confirmMsg"
        style="margin-bottom: 24px; color: var(--text-color); font-size: 14px; text-align: left; white-space: pre-wrap; word-break: break-all;">
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button id="confirmCancelBtn"
          style="padding: 10px 16px; border-radius: 6px; border: 1px solid var(--sidebar-border); background: transparent; color: var(--text-color); cursor: pointer; font-family: inherit; font-size: 14px;">ì·¨ì†Œ</button>
        <button id="confirmOkBtn"
          style="padding: 10px 16px; border-radius: 6px; border: none; background: #dc3545; color: white; cursor: pointer; font-family: inherit; font-size: 14px; font-weight: 600;">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      // Feature Flag for Edit/Delete actions
      const FEATURE_MEMO_EDIT_ENABLED_USERS = ["ì†¡ìš©ë‚¨", "ì •í˜œë¦¼"];

      const memoInput = document.getElementById('memoInput');
      const memoViewer = document.getElementById('memoViewer');

      // ë‹¨ì¶•í‚¤ ì„¤ì • (Cmd+Enter / Ctrl+Enter ë¡œ ì €ì¥)
      memoInput.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
          e.preventDefault();
          if (currentMode === 'write') {
            saveMemo('saveFromWeb');
          }
        }
      });

      const saveBtn = document.getElementById('saveBtn');
      const extractBtn = document.getElementById('extractBtn');
      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      const toastStatus = document.getElementById('toastStatus');

      // Theme Elements
      const themeToggleBtn = document.getElementById('themeToggleBtn');
      const htmlEl = document.documentElement;

      // Layout Elements
      const folderList = document.getElementById('folderList');
      const newMemoBtn = document.getElementById('newMemoBtn');
      const editorHeader = document.getElementById('editorHeader');
      const editorFooter = document.getElementById('editorFooter');
      const viewTitle = document.getElementById('viewTitle');
      const summarizeBtn = document.getElementById('summarizeBtn');
      const summaryOverlay = document.getElementById('summaryOverlay');
      const summaryContent = document.getElementById('summaryContent');
      const closeSummaryBtn = document.getElementById('closeSummaryBtn');
      const sidebar = document.getElementById('sidebar');
      const menuBtn = document.getElementById('menuBtn');
      const mobileOverlay = document.getElementById('mobileOverlay');

      // Auth Elements
      const userBadge = document.getElementById('userBadge');
      const accessDeniedOverlay = document.getElementById('accessDeniedOverlay');
      const accessDeniedMsg = document.getElementById('accessDeniedMsg');

      // State Variable
      let currentMode = 'write'; // 'write' or 'read'
      let currentHtmlTheme = 'dark';
      let currentUserName = null; // Magic Link ì¸ì¦ ì™„ë£Œ í›„ í™•ë³´ëœ ì‚¬ìš©ì ì´ë¦„
      let cachedSidebarData = null; // ê²€ìƒ‰ ì·¨ì†Œ ì‹œ ë³µêµ¬í•  ì›ë˜ í´ë” ë¦¬ìŠ¤íŠ¸ ë°ì´í„°
      const searchInput = document.getElementById('searchInput');

      // ==========================================
      // 0. í…Œë§ˆ ê´€ë¦¬ & ëª¨ë°”ì¼ UI ì»¨íŠ¸ë¡¤
      // ==========================================
      const savedTheme = localStorage.getItem('judy_note_theme') || 'dark';
      setTheme(savedTheme);

      themeToggleBtn.addEventListener('click', () => {
        const newTheme = currentHtmlTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
      });

      function setTheme(theme) {
        currentHtmlTheme = theme;
        htmlEl.setAttribute('data-theme', theme);
        themeToggleBtn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        localStorage.setItem('judy_note_theme', theme);
      }

      // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” í† ê¸€
      function toggleMobileMenu() {
        sidebar.classList.toggle('open');
        mobileOverlay.classList.toggle('show');
      }

      function closeMobileMenu() {
        sidebar.classList.remove('open');
        mobileOverlay.classList.remove('show');
      }

      menuBtn.addEventListener('click', toggleMobileMenu);
      mobileOverlay.addEventListener('click', closeMobileMenu);

      // ==========================================
      // 1. [Phase 10] ìŠ¬ë™ ê¸°ë°˜ Magic Link (One-Time Token) ê²€ì¦
      // ==========================================
      function showAccessDenied(reason) {
        accessDeniedMsg.innerHTML = reason;
        accessDeniedOverlay.style.display = 'flex';
      }

      // êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ íŠ¹ì„±ìƒ window.location.searchê°€ ì‘ë™í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ,
      // doGetì—ì„œ ì£¼ì…í•´ì¤€ ì„œë²„ ì‚¬ì´ë“œ í…œí”Œë¦¿ ë³€ìˆ˜(token)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
      const magicToken = "<?= token ?>";

      if (!magicToken) {
        userBadge.textContent = 'â›” ë¯¸ì¸ê°€';
        showAccessDenied('ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ëœ ì ‘ì† ì •ë³´ì…ë‹ˆë‹¤.<br>ìŠ¬ë™ì•±ì—ì„œ [ì£¼ë”” ë…¸íŠ¸ ì—´ì–´ì¤˜] ë¡œ ë‹¤ì‹œ ì ‘ì†í•˜ì„¸ìš”.');
      } else {
        // ì„œë²„ë¥¼ í†µí•´ í† í° ìœ íš¨ì„± ê²€ì¦
        google.script.run
          .withSuccessHandler((result) => {
            if (result.valid) {
              // âœ… ì¸ì¦ í†µê³¼: ì´ë¦„ í‘œì‹œ ë° ë³¸ì¸ ë°ì´í„° ë¡œë”©
              currentUserName = result.name;
              userBadge.textContent = `ğŸ‘¤ ${result.name} ë‹˜`;
              loadSidebarData(result.name);

              // ë³´ì•ˆ ëª©ì  + ë¯¸ê´€ìƒ URLì—ì„œ í† í° ìˆ¨ê¸°ê¸° (pushState ì‚¬ìš©)
              if (window.history.replaceState) {
                const cleanUrl = window.location.href.split('?')[0];
                window.history.replaceState({}, document.title, cleanUrl);
              }
            } else {
              // âŒ ì¸ì¦ ì‹¤íŒ¨ (ë§Œë£Œ, ì—†ëŠ” í† í°, ì´ë¯¸ ì‚¬ìš©ëœ í† í°)
              userBadge.textContent = 'â›” ë¯¸ì¸ê°€';
              showAccessDenied(result.reason);
            }
          })
          .withFailureHandler((err) => {
            userBadge.textContent = 'â›” ë³´ì•ˆ ì—ëŸ¬';
            showAccessDenied('ì¸ì¦ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ìƒˆë¡œê³ ì¹¨ í•˜ê±°ë‚˜ ìŠ¬ë™ì—ì„œ ë‹¤ì‹œ ì ‘ì†í•˜ì„¸ìš”.');
          })
          .validateToken(magicToken);
      }

      // ==========================================
      // 2. ëª¨ë“œ ì „í™˜ (Write <-> Read)
      // ==========================================
      newMemoBtn.addEventListener('click', () => {
        setToWriteMode();
      });

      function setToWriteMode() {
        currentMode = 'write';
        editorHeader.style.display = 'none';
        editorFooter.style.display = 'flex';

        memoInput.style.display = 'block';
        memoViewer.style.display = 'none';
        memoInput.value = '';
        memoInput.focus();
        summaryOverlay.classList.remove('show');

        closeMobileMenu(); // ëª¨ë°”ì¼ í™˜ê²½: ì“°ê¸° ëª¨ë“œ ì§„ì… ì‹œ ì‚¬ì´ë“œë°” ë‹«ê¸°
      }

      function setToReadMode(title, contentOrMemos, dateStr) {
        currentMode = 'read';
        editorHeader.style.display = 'flex';
        editorFooter.style.display = 'none';
        viewTitle.textContent = title;

        memoInput.style.display = 'none';
        memoViewer.style.display = 'flex';
        memoViewer.style.flexDirection = 'column';
        memoViewer.innerHTML = '';

        if (Array.isArray(contentOrMemos)) {
          contentOrMemos.forEach(m => {
            const block = createMemoBlock(dateStr, m.time, m.content);
            memoViewer.appendChild(block);
          });
        } else {
          memoViewer.textContent = contentOrMemos.trim();
        }

        summaryOverlay.classList.remove('show');
        closeMobileMenu();
      }

      // ==========================================
      // 3. ì‚¬ì´ë“œë°” ë Œë”ë§ ë° ê²€ìƒ‰ í•¸ë“¤ë§
      // ==========================================
      function loadSidebarData(userName) {
        folderList.innerHTML = '<div class="loading-text">í´ë” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        if (searchInput) searchInput.value = ''; // ì´ˆê¸°í™”

        google.script.run
          .withSuccessHandler((data) => {
            try {
              cachedSidebarData = data;
              renderSidebar(data);
            } catch (err) {
              console.error("Render Error:", err);
              folderList.innerHTML = '<div class="loading-text" style="color:#f44336;">ì‚¬ì´ë“œë°” ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
          })
          .withFailureHandler((err) => {
            console.error("Backend Error:", err);
            folderList.innerHTML = `<div class="loading-text" style="color:#f44336;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>(${err.message})</div>`;
          })
          .getArchivedMemos(userName); // Backend í•¨ìˆ˜
      }

      if (searchInput) {
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const query = e.target.value.trim();
            const userName = currentUserName;
            if (!userName) return;

            if (query === '') {
              renderSidebar(cachedSidebarData);
              return;
            }

            // ê²€ìƒ‰ ëª¨ë“œ ì§„ì…
            folderList.innerHTML = '<div class="loading-text">ê²€ìƒ‰ ì¤‘... ğŸ”</div>';
            google.script.run
              .withSuccessHandler((results) => {
                renderSearchResults(results, query);
              })
              .withFailureHandler((err) => {
                folderList.innerHTML = '<div class="loading-text" style="color:#f44336;">ê²€ìƒ‰ ì‹¤íŒ¨</div>';
                console.error(err);
              })
              .searchArchivedMemos(userName, query);
          }
        });
      }

      function renderSearchResults(results, query) {
        folderList.innerHTML = '';

        const clearBtn = document.createElement('div');
        clearBtn.className = 'loading-text';
        clearBtn.style.cursor = 'pointer';
        clearBtn.style.color = 'var(--primary)';
        clearBtn.style.fontWeight = '500';
        clearBtn.textContent = 'â† í´ë” ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
        clearBtn.addEventListener('click', () => {
          searchInput.value = '';
          renderSidebar(cachedSidebarData);
        });
        folderList.appendChild(clearBtn);

        if (!results || results.length === 0) {
          const emptyInfo = document.createElement('div');
          emptyInfo.className = 'loading-text';
          emptyInfo.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
          folderList.appendChild(emptyInfo);
          return;
        }

        results.forEach(res => {
          const d = document.createElement('div');
          d.className = 'search-result-item';

          const dateDiv = document.createElement('div');
          dateDiv.className = 'search-result-date';
          dateDiv.textContent = `${res.date} ${res.time}`;

          const textDiv = document.createElement('div');
          textDiv.className = 'search-result-text';

          // Highlight The Match
          const safeQuery = query.replace(/[.*+?^${ }()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${safeQuery})`, 'gi');
          // XSS ë°©ì–´ (ê°„ë‹¨í•œ escape í›„ highlight ì ìš©)
          let escapedContent = res.content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          escapedContent = escapedContent.replace(regex, '<span class="highlight">$1</span>');
          textDiv.innerHTML = escapedContent;

          d.appendChild(dateDiv);
          d.appendChild(textDiv);

          d.addEventListener('click', () => {
            // ê²€ìƒ‰ëœ ì›ë¬¸ì„ í´ë¦­í•˜ë©´ ìš°ì¸¡ ë·°ì–´ì— ë³´ì—¬ì¤Œ
            setToReadMode(res.date + " ê²€ìƒ‰ ê²°ê³¼", [{ time: res.time, content: res.content }], res.date);
          });

          folderList.appendChild(d);
        });
      }

      function renderSidebar(data) {
        // data: [{month: "2026-02", days: [ {date: "2026-02-22 (ì¼)", memos: [ {time: "14:30 PM", content: "..." } ] } ] }]
        if (!data || data.length === 0) {
          folderList.innerHTML = '<div class="loading-text">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        folderList.innerHTML = '';
        data.forEach(monthData => {
          const folderDiv = document.createElement('div');
          folderDiv.className = 'folder-item';

          const titleDiv = document.createElement('div');
          titleDiv.className = 'folder-title';
          titleDiv.innerHTML = `<span class="folder-icon">ğŸ“</span> ${monthData.month} ì—…ë¬´ì¼ì§€`;

          const childrenDiv = document.createElement('div');
          childrenDiv.className = 'folder-children';

          monthData.days.forEach(dayData => {
            // í•˜ìœ„ í´ë”: ë‚ ì§œë³„ ë¬¶ìŒ (ë˜ëŠ” íŒŒì¼ ë¦¬ìŠ¤íŠ¸)
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            fileDiv.textContent = `ğŸ“„ ${dayData.date}`;
            fileDiv.addEventListener('click', () => {
              // í•´ë‹¹ ë‚ ì§œ í´ë¦­ ì‹œ ëª¨ë“  ë©”ëª¨ ì·¨í•©í•´ì„œ ì½ê¸° ëª¨ë“œë¡œ ì§„ì…
              setToReadMode(dayData.date, dayData.memos, dayData.date);
            });
            childrenDiv.appendChild(fileDiv);
          });

          titleDiv.addEventListener('click', () => {
            folderDiv.classList.toggle('open');
          });

          folderDiv.appendChild(titleDiv);
          folderDiv.appendChild(childrenDiv);
          folderList.appendChild(folderDiv);
        });

        // ì²« ë²ˆì§¸ í´ë”ëŠ” ê¸°ë³¸ ì—´ì–´ë‘ê¸°
        if (document.querySelector('.folder-item')) {
          document.querySelector('.folder-item').classList.add('open');
        }
      }

      // ==========================================
      // 4. ìƒˆ ë©”ëª¨ ì €ì¥ / ì—…ë¬´ ì¶”ì¶œ ë¡œì§
      // ==========================================
      // (ë‹¨ì¶•í‚¤ ë¦¬ìŠ¤ë„ˆëŠ” initEditor() ë¡œ ì´ë™ë¨)

      saveBtn.addEventListener('click', () => saveMemo('saveFromWeb'));
      extractBtn.addEventListener('click', () => saveMemo('extractFromWeb'));

      function showToast(message, isError = false) {
        toastMsg.textContent = message;
        toastStatus.style.background = isError ? '#f44336' : '#4caf50';
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
        }, 5000);
      }

      function saveMemo(actionName) {
        const text = memoInput ? memoInput.value.trim() : '';
        const userName = currentUserName;
        const isExtract = actionName === 'extractFromWeb';

        if (!userName) {
          showToast('â›” ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.', false);
          return;
        }

        if (!text) {
          if (memoInput) memoInput.focus();
          return;
        }

        // UI ìƒíƒœ ë³€ê²½ (ì €ì¥ ì¤‘)
        saveBtn.disabled = true;
        extractBtn.disabled = true;

        const prevSaveText = saveBtn.textContent;
        const prevExtractText = extractBtn.textContent;

        if (isExtract) {
          extractBtn.textContent = "AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ğŸª„";
        } else {
          saveBtn.textContent = "ì €ì¥ ì¤‘...";
        }

        const runner = google.script.run
          .withSuccessHandler((res) => {
            saveBtn.disabled = false;
            extractBtn.disabled = false;
            saveBtn.textContent = prevSaveText;
            extractBtn.textContent = prevExtractText;

            if (res && res.success) {
              if (memoInput) memoInput.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
              showToast(res.message);
              if (memoInput) memoInput.focus();

              // ì‚¬ì´ë“œë°” ì‹¤ì‹œê°„ ê°±ì‹  (ì €ì¥ ì¦‰ì‹œ ê°±ì‹ )
              loadSidebarData(userName);
            } else {
              showToast("âŒ ì—ëŸ¬: " + (res ? res.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬"), true);
            }
          })
          .withFailureHandler((err) => {
            saveBtn.disabled = false;
            extractBtn.disabled = false;
            saveBtn.textContent = prevSaveText;
            extractBtn.textContent = prevExtractText;
            showToast("âŒ ì„œë²„ í†µì‹  ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
            console.error("Save Error:", err);
          });

        if (actionName === 'saveFromWeb') {
          runner.saveFromWeb(userName, text);
        } else {
          runner.extractFromWeb(userName, text);
        }
      }

      // ==========================================
      // 5. ëª¨ë‹¬ í˜•íƒœ AI ìš”ì•½
      // ==========================================
      closeSummaryBtn.addEventListener('click', () => {
        summaryOverlay.classList.remove('show');
      });

      summarizeBtn.addEventListener('click', () => {
        let text = '';
        if (memoViewer && memoViewer.querySelector('.memo-content')) {
          text = Array.from(memoViewer.querySelectorAll('.memo-content')).map(el => el.textContent).join('\n\n');
        } else if (memoViewer) {
          text = memoViewer.textContent.trim();
        }
        const userName = currentUserName;

        if (!text) return;

        summarizeBtn.disabled = true;
        summarizeBtn.textContent = "ìš”ì•½ ì¤‘... ğŸª„";

        google.script.run
          .withSuccessHandler((res) => {
            summarizeBtn.disabled = false;
            summarizeBtn.textContent = "âœ¨ AI ë‚´ìš© ìš”ì•½";

            if (res.success) {
              summaryContent.textContent = res.summary;
              summaryOverlay.classList.add('show');
            } else {
              showToast("âŒ ìš”ì•½ ì‹¤íŒ¨: " + res.message, true);
            }
          })
          .withFailureHandler((err) => {
            summarizeBtn.disabled = false;
            summarizeBtn.textContent = "âœ¨ AI ë‚´ìš© ìš”ì•½";
            showToast("âŒ ì„œë²„ í†µì‹  ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
          })
          .summarizeMemoContent(text, userName);
      });

      // ==========================================
      // 6. ì£¼ë”” ë…¸íŠ¸ V2: ì•¡ì…˜ ë²„íŠ¼ ë° ëª¨ë‹¬ ë¡œì§ (ìˆ˜ì •, ì™„ë£Œ, ì‚­ì œ)
      // ==========================================
      function createMemoBlock(dateStr, timeStr, originalContent) {
        const wrapper = document.createElement('div');
        wrapper.className = 'memo-block';

        let currentContent = originalContent;

        const headerDiv = document.createElement('div');
        headerDiv.className = 'memo-header';

        const timeSpan = document.createElement('span');
        timeSpan.className = 'memo-time';
        timeSpan.textContent = `[${timeStr}]`;
        headerDiv.appendChild(timeSpan);

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'action-buttons';

        const btnEdit = document.createElement('button');
        btnEdit.className = 'action-edit';
        btnEdit.innerHTML = 'âœï¸';
        btnEdit.title = 'ìˆ˜ì •';

        const btnDone = document.createElement('button');
        btnDone.className = 'action-done';
        btnDone.innerHTML = 'âœ“';
        btnDone.title = 'ì™„ë£Œ(ì·¨ì†Œì„ )';

        const btnDel = document.createElement('button');
        btnDel.className = 'action-delete danger';
        btnDel.innerHTML = 'ğŸ—‘ï¸';
        btnDel.title = 'ì‚­ì œ';

        actionsDiv.appendChild(btnEdit);
        actionsDiv.appendChild(btnDone);
        actionsDiv.appendChild(btnDel);
        headerDiv.appendChild(actionsDiv);

        // Feature Flag Check
        if (!FEATURE_MEMO_EDIT_ENABLED_USERS.includes(currentUserName)) {
          actionsDiv.style.display = 'none';
        }

        const contentDiv = document.createElement('div');
        contentDiv.className = 'memo-content';
        contentDiv.textContent = currentContent;

        if (currentContent.startsWith('~~') && currentContent.endsWith('~~')) {
          contentDiv.style.textDecoration = 'line-through';
          contentDiv.style.color = 'var(--hint-color)';
        }

        const editForm = document.createElement('div');
        editForm.className = 'memo-edit-form';
        editForm.style.display = 'none';

        const textarea = document.createElement('textarea');
        textarea.className = 'edit-input';

        const editActions = document.createElement('div');
        editActions.className = 'edit-actions';

        const btnSaveEdit = document.createElement('button');
        btnSaveEdit.className = 'btn-save-sm';
        btnSaveEdit.textContent = 'ì €ì¥';

        const btnCancelEdit = document.createElement('button');
        btnCancelEdit.className = 'btn-cancel-sm';
        btnCancelEdit.textContent = 'ì·¨ì†Œ';

        editActions.appendChild(btnCancelEdit);
        editActions.appendChild(btnSaveEdit);
        editForm.appendChild(textarea);
        editForm.appendChild(editActions);

        wrapper.appendChild(headerDiv);
        wrapper.appendChild(contentDiv);
        wrapper.appendChild(editForm);

        // Edit Mode Toggle
        btnEdit.addEventListener('click', () => {
          contentDiv.style.display = 'none';
          editForm.style.display = 'flex';
          let editableText = currentContent;
          if (editableText.startsWith('~~') && editableText.endsWith('~~')) {
            editableText = editableText.substring(2, editableText.length - 2);
          }
          textarea.value = editableText;
          textarea.focus();
        });

        btnCancelEdit.addEventListener('click', () => {
          contentDiv.style.display = 'block';
          editForm.style.display = 'none';
        });

        btnSaveEdit.addEventListener('click', () => {
          const newText = textarea.value.trim();
          if (!newText || newText === currentContent) {
            btnCancelEdit.click();
            return;
          }
          btnSaveEdit.disabled = true;
          btnSaveEdit.textContent = 'ì €ì¥ ì¤‘...';

          google.script.run
            .withSuccessHandler(res => {
              btnSaveEdit.disabled = false;
              btnSaveEdit.textContent = 'ì €ì¥';
              if (res.success) {
                currentContent = res.newContent;
                contentDiv.textContent = currentContent;
                if (currentContent.startsWith('~~') && currentContent.endsWith('~~')) {
                  contentDiv.style.textDecoration = 'line-through';
                  contentDiv.style.color = 'var(--hint-color)';
                } else {
                  contentDiv.style.textDecoration = 'none';
                  contentDiv.style.color = '';
                }
                btnCancelEdit.click();
                showToast('ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                cachedSidebarData = null; // force reload next time
              } else {
                showToast('âŒ ìˆ˜ì • ì‹¤íŒ¨: ' + res.message, true);
              }
            })
            .withFailureHandler(err => {
              btnSaveEdit.disabled = false;
              btnSaveEdit.textContent = 'ì €ì¥';
              showToast('âŒ ì„œë²„ í†µì‹  ì—ëŸ¬', true);
            })
            .editArchivedMemo({
              userName: currentUserName,
              dateStr: dateStr,
              timeStr: timeStr,
              originalContent: currentContent,
              newContent: newText
            });
        });

        btnDone.addEventListener('click', () => {
          btnDone.disabled = true;
          google.script.run
            .withSuccessHandler(res => {
              btnDone.disabled = false;
              if (res.success) {
                currentContent = res.newContent;
                contentDiv.textContent = currentContent;
                if (currentContent.startsWith('~~') && currentContent.endsWith('~~')) {
                  contentDiv.style.textDecoration = 'line-through';
                  contentDiv.style.color = 'var(--hint-color)';
                } else {
                  contentDiv.style.textDecoration = 'none';
                  contentDiv.style.color = '';
                }
                showToast('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                cachedSidebarData = null; // expire cache
              } else {
                showToast('âŒ ì‹¤íŒ¨: ' + res.message, true);
              }
            })
            .withFailureHandler(err => {
              btnDone.disabled = false;
              showToast('âŒ í†µì‹  ì—ëŸ¬', true);
            })
            .toggleStrikethroughMemo({
              userName: currentUserName,
              dateStr: dateStr,
              timeStr: timeStr,
              originalContent: currentContent
            });
        });

        btnDel.addEventListener('click', () => {
          executeDeleteFlow(wrapper, currentUserName, dateStr, timeStr, currentContent);
        });

        // ëª¨ë°”ì¼ í„°ì¹˜ ë…¸ì¶œ
        wrapper.addEventListener('touchstart', () => {
          wrapper.classList.add('touched');
          setTimeout(() => wrapper.classList.remove('touched'), 3000);
        });

        return wrapper;
      }

      let currentDeleteAction = null;
      const confirmModal = document.getElementById('confirmModal');
      const confirmMsg = document.getElementById('confirmMsg');
      const confirmCancelBtn = document.getElementById('confirmCancelBtn');
      const confirmOkBtn = document.getElementById('confirmOkBtn');

      function executeDeleteFlow(memoBlock, userName, dateStr, timeStr, originalContent) {
        const preview = originalContent.length > 50 ? originalContent.substring(0, 50) + "..." : originalContent;
        confirmMsg.innerText = `ë‹¤ìŒ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n"${preview}"\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;

        currentDeleteAction = () => {
          confirmModal.style.display = 'none';
          const btnDel = memoBlock.querySelector('.action-delete');
          if (btnDel) btnDel.disabled = true;

          google.script.run
            .withSuccessHandler(res => {
              if (res.success) {
                memoBlock.style.transition = 'opacity 0.3s';
                memoBlock.style.opacity = '0';
                setTimeout(() => memoBlock.remove(), 300);
                showToast('ğŸ—‘ï¸ ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                cachedSidebarData = null;
              } else {
                if (btnDel) btnDel.disabled = false;
                showToast('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + res.message, true);
              }
            })
            .withFailureHandler(err => {
              if (btnDel) btnDel.disabled = false;
              showToast('âŒ í†µì‹  ì—ëŸ¬', true);
            })
            .deleteArchivedMemo({ userName, dateStr, timeStr, originalContent });
        };

        confirmModal.style.display = 'flex';
        confirmCancelBtn.focus();
      }

      confirmCancelBtn.addEventListener('click', () => {
        confirmModal.style.display = 'none';
        currentDeleteAction = null;
      });

      confirmOkBtn.addEventListener('click', () => {
        if (currentDeleteAction) currentDeleteAction();
      });

      // ì´ˆê¸° í¬ì»¤ìŠ¤ ë° ì´ˆê¸°í™”
      if (memoInput) memoInput.focus();
    });
  </script>
</body>

</html>